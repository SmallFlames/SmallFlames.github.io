<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>南汐</title>
  
  <subtitle>勇敢的去做你认为正确的事情！</subtitle>
  <link href="https://smallflames.github.io/atom.xml" rel="self"/>
  
  <link href="https://smallflames.github.io/"/>
  <updated>2024-01-21T11:35:17.643Z</updated>
  <id>https://smallflames.github.io/</id>
  
  <author>
    <name>Xia Zheng</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Ansible一键部署实例（三）</title>
    <link href="https://smallflames.github.io/2024/01/21/Ansible%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2%E5%AE%9E%E4%BE%8B%EF%BC%88%E4%B8%89%EF%BC%89/"/>
    <id>https://smallflames.github.io/2024/01/21/Ansible%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2%E5%AE%9E%E4%BE%8B%EF%BC%88%E4%B8%89%EF%BC%89/</id>
    <published>2024-01-21T10:36:01.000Z</published>
    <updated>2024-01-21T11:35:17.643Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>Ansible一键部署实例（三）</center></h1><table><tr><td bgcolor=#000000><font color="white">业务部署代码</font></td></tr></table><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wordpress业务部署</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/wordpress</span>]<span class="comment">#tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">├──</span> <span class="string">files</span></span><br><span class="line"><span class="string">│</span>   <span class="string">├──</span> <span class="string">wordpress.conf</span></span><br><span class="line"><span class="string">│</span>   <span class="string">├──</span> <span class="string">wordpress.sql</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">wordpress.tar.gz</span></span><br><span class="line"><span class="string">├──</span> <span class="string">handlers</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">tasks</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">templates</span></span><br><span class="line"><span class="string">└──</span> <span class="string">vars</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span> <span class="string">directories,</span> <span class="number">6</span> <span class="string">files</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/wordpress</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tasks file for wordpress</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">remove</span> <span class="string">nginx</span> <span class="string">default.conf</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/etc/nginx/conf.d/default.conf</span> <span class="string">warn=false</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">configure</span> <span class="string">wordpress</span> <span class="string">nginx</span> <span class="string">server</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">wordpress.conf</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/nginx/conf.d</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">web</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">wordpress</span> <span class="string">code</span> <span class="string">dir</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/code/wordpress</span></span><br><span class="line">    <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Extract</span> <span class="string">wordpress.tar.gz</span> <span class="string">into</span> <span class="string">web</span> <span class="string">/code</span></span><br><span class="line">  <span class="attr">unarchive:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">wordpress.tar.gz</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/code/wordpress</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Modify</span> <span class="string">directory</span> <span class="string">permissions</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">chown</span> <span class="string">-R</span> <span class="string">www.www</span> <span class="string">/code</span> <span class="string">warn=false</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sent</span> <span class="string">wordpress.sql</span> <span class="string">to</span> <span class="string">db</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">wordpress.sql</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/tmp</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;db&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">import</span> <span class="string">wordpress.sql</span></span><br><span class="line">  <span class="attr">mysql_db:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">all</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">import</span></span><br><span class="line">    <span class="attr">target:</span> <span class="string">/tmp/wordpress.sql</span></span><br><span class="line">  <span class="attr">register:</span> <span class="string">result</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;db&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">nginx</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">mariadb</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mariadb</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;db&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mount</span> <span class="string">dir</span> <span class="string">to</span> <span class="string">nfs1</span></span><br><span class="line">  <span class="attr">mount:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.31</span><span class="string">:/data/wordpress</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/code/wordpress/wp-content/uploads</span></span><br><span class="line">    <span class="attr">fstype:</span> <span class="string">nfs</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">mounted</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><span id="more"></span><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kod业务部署</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/kod</span>]<span class="comment">#tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">├──</span> <span class="string">files</span></span><br><span class="line"><span class="string">│</span>   <span class="string">├──</span> <span class="string">kod.conf</span></span><br><span class="line"><span class="string">│</span>   <span class="string">├──</span> <span class="string">kod.sql</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">kod.tar.gz</span></span><br><span class="line"><span class="string">├──</span> <span class="string">handlers</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">tasks</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">templates</span></span><br><span class="line"><span class="string">└──</span> <span class="string">vars</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span> <span class="string">directories,</span> <span class="number">6</span> <span class="string">files</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/kod</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tasks file for kod</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">remove</span> <span class="string">nginx</span> <span class="string">default.conf</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/etc/nginx/conf.d/default.conf</span> <span class="string">warn=false</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">configure</span> <span class="string">kod</span> <span class="string">nginx</span> <span class="string">server</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">kod.conf</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/nginx/conf.d</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">web</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">kod</span> <span class="string">code</span> <span class="string">dir</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/code/kod</span></span><br><span class="line">    <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Extract</span> <span class="string">kod.tar.gz</span> <span class="string">into</span> <span class="string">web</span> <span class="string">/code</span></span><br><span class="line">  <span class="attr">unarchive:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">kod.tar.gz</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/code/kod</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Modify</span> <span class="string">directory</span> <span class="string">permissions</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">chown</span> <span class="string">-R</span> <span class="string">www.www</span> <span class="string">/code</span> <span class="string">warn=false</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sent</span> <span class="string">kod.sql</span> <span class="string">to</span> <span class="string">db</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">kod.sql</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/tmp</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;db&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">import</span> <span class="string">kod.sql</span></span><br><span class="line">  <span class="attr">mysql_db:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">all</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">import</span></span><br><span class="line">    <span class="attr">target:</span> <span class="string">/tmp/kod.sql</span></span><br><span class="line">  <span class="attr">register:</span> <span class="string">result</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;db&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">nginx</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">mariadb</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mariadb</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;db&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mount</span> <span class="string">dir</span> <span class="string">to</span> <span class="string">nfs1</span></span><br><span class="line">  <span class="attr">mount:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.31</span><span class="string">:/data/kod</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/code/kod/data/files</span></span><br><span class="line">    <span class="attr">fstype:</span> <span class="string">nfs</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">mounted</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署tomcat服务</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/tomcat</span>]<span class="comment">#tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">├──</span> <span class="string">files</span></span><br><span class="line"><span class="string">│</span>   <span class="string">├──</span> <span class="string">context.xml</span></span><br><span class="line"><span class="string">│</span>   <span class="string">├──</span> <span class="string">jdk.rpm</span></span><br><span class="line"><span class="string">│</span>   <span class="string">├──</span> <span class="string">redis-data-cache.properties</span></span><br><span class="line"><span class="string">│</span>   <span class="string">├──</span> <span class="string">tomcat.service</span></span><br><span class="line"><span class="string">│</span>   <span class="string">├──</span> <span class="string">tomcat_session.tar.gz</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">tomcat.tar.gz</span></span><br><span class="line"><span class="string">├──</span> <span class="string">handlers</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">tasks</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">templates</span></span><br><span class="line"><span class="string">└──</span> <span class="string">vars</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span> <span class="string">directories,</span> <span class="number">9</span> <span class="string">files</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/tomcat</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tasks file for tomcat</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sent</span> <span class="string">jdk.rpm</span> <span class="string">and</span> <span class="string">tomcat.service</span> <span class="string">to</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/tmp</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">jdk.rpm</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tomcat.service</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">java</span> <span class="string">environment</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">yum</span> <span class="string">-y</span> <span class="string">localinstall</span> <span class="string">/tmp/jdk.rpm</span> <span class="string">warn=false</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">configure</span> <span class="string">systemctl</span> <span class="string">for</span> <span class="string">tomcat</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">tomcat.service</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/usr/lib/systemd/system</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">soft</span> <span class="string">dir</span> <span class="string">for</span> <span class="string">tomcat</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/soft</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Extract</span> <span class="string">tomcat.tar.gz</span> <span class="string">into</span> <span class="string">web</span> <span class="string">/soft</span></span><br><span class="line">  <span class="attr">unarchive:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">tomcat.tar.gz</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/soft</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">tomcat</span> <span class="string">link</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">/soft/apache-tomcat-9.0.84</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/soft/tomcat</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">link</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Extract</span> <span class="string">tomcat_session.tar.gz</span> <span class="string">into</span> <span class="string">web</span> <span class="string">tomcat</span> <span class="string">for</span> <span class="string">session</span> <span class="string">share</span></span><br><span class="line">  <span class="attr">unarchive:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">tomcat_session.tar.gz</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/soft/tomcat/lib</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cp</span> <span class="string">redis-data-cache.properties</span> <span class="string">and</span> <span class="string">context.xml</span> <span class="string">to</span> <span class="string">tomcat</span> <span class="string">for</span> <span class="string">session</span> <span class="string">share</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/soft/tomcat/conf</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">redis-data-cache.properties</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">context.xml</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">reload</span> <span class="string">by</span> <span class="string">systemctl</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">systemctl</span> <span class="string">daemon-reload</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">systemctl</span> <span class="string">restart</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">systemctl</span> <span class="string">enable</span> <span class="string">tomcat</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">remove</span> <span class="string">remains</span> <span class="string">for</span> <span class="string">tomcat</span></span><br><span class="line">  <span class="attr">shell:</span>  <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/tmp/jdk.rpm</span> <span class="string">/tmp/sys_tomcat</span> <span class="string">warn=false</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zrlog服务部署</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/zrlog</span>]<span class="comment">#tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">├──</span> <span class="string">files</span></span><br><span class="line"><span class="string">│</span>   <span class="string">├──</span> <span class="string">server.xml</span></span><br><span class="line"><span class="string">│</span>   <span class="string">├──</span> <span class="string">zrlog.sql</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">zrlog.tar.gz</span></span><br><span class="line"><span class="string">├──</span> <span class="string">handlers</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">tasks</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">templates</span></span><br><span class="line"><span class="string">└──</span> <span class="string">vars</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span> <span class="string">directories,</span> <span class="number">6</span> <span class="string">files</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/zrlog</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tasks file for zrlog</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">configure</span> <span class="string">zrlog</span> <span class="string">server</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">server.xml</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/soft/tomcat/conf</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">zrlog</span> <span class="string">code</span> <span class="string">dir</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/code/zrlog/ROOT</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sent</span> <span class="string">zrlog.sql</span> <span class="string">to</span> <span class="string">db</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">zrlog.sql</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/tmp</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;db&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">import</span> <span class="string">zrlog.sql</span></span><br><span class="line">  <span class="attr">mysql_db:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">all</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">import</span></span><br><span class="line">    <span class="attr">target:</span> <span class="string">/tmp/zrlog.sql</span></span><br><span class="line">  <span class="attr">register:</span> <span class="string">result</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;db&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">mariadb</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mariadb</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;db&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Extract</span> <span class="string">zrlog.tar.gz</span> <span class="string">into</span> <span class="string">web</span> <span class="string">/code/zrlog/ROOT</span></span><br><span class="line">  <span class="attr">unarchive:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">zrlog.tar.gz</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/code/zrlog/ROOT</span></span><br><span class="line">  <span class="attr">ignore_errors:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">tomcat</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">systemctl</span> <span class="string">restart</span> <span class="string">tomcat</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mount</span> <span class="string">dir</span> <span class="string">to</span> <span class="string">nfs1</span></span><br><span class="line">  <span class="attr">mount:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.31</span><span class="string">:/data/zrlog</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/code/zrlog/ROOT/attached</span></span><br><span class="line">    <span class="attr">fstype:</span> <span class="string">nfs</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">mounted</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># phpmyadmin部署</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/phpadmin</span>]<span class="comment">#tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">├──</span> <span class="string">files</span></span><br><span class="line"><span class="string">│</span>   <span class="string">├──</span> <span class="string">admin.conf</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">phpadmin.tar.gz</span></span><br><span class="line"><span class="string">├──</span> <span class="string">handlers</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">tasks</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">templates</span></span><br><span class="line"><span class="string">└──</span> <span class="string">vars</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span> <span class="string">directories,</span> <span class="number">5</span> <span class="string">files</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/phpadmin</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tasks file for phpadmin</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">remove</span> <span class="string">nginx</span> <span class="string">default.conf</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/etc/nginx/conf.d/default.conf</span> <span class="string">warn=false</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">configure</span> <span class="string">admin</span> <span class="string">server</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">admin.conf</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/nginx/conf.d</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">admin</span> <span class="string">code</span> <span class="string">dir</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/code/phpadmin</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Extract</span> <span class="string">phpadmin.tar.gz</span> <span class="string">into</span> <span class="string">web</span> <span class="string">code_dir</span></span><br><span class="line">  <span class="attr">unarchive:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">phpadmin.tar.gz</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/code/phpadmin</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Modify</span> <span class="string">directory</span> <span class="string">permissions</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">chown</span> <span class="string">-R</span> <span class="string">www.www</span> <span class="string">/code</span> <span class="string">warn=false</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><table><tr><td bgcolor=#000000><font color="white">服务部署代码</font></td></tr></table><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 负载均衡配置</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/lb_nginx</span>]<span class="comment">#tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">├──</span> <span class="string">files</span></span><br><span class="line"><span class="string">│</span>   <span class="string">├──</span> <span class="string">proxy.conf</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">proxy_params</span></span><br><span class="line"><span class="string">├──</span> <span class="string">handlers</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">tasks</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">templates</span></span><br><span class="line"><span class="string">└──</span> <span class="string">vars</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span> <span class="string">directories,</span> <span class="number">5</span> <span class="string">files</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/lb_nginx</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tasks file for lb_nginx</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">remove</span> <span class="string">nginx</span> <span class="string">default.conf</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/etc/nginx/conf.d/default.conf</span> <span class="string">warn=false</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Reverse</span> <span class="string">proxy</span> <span class="string">proxy_params</span> <span class="string">and</span> <span class="string">Proxy</span> <span class="string">server</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.src &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.dest &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">src:</span> <span class="string">proxy_params</span>,<span class="attr">dest:</span> <span class="string">/etc/nginx</span> &#125;</span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">src:</span> <span class="string">proxy.conf</span>,<span class="attr">dest:</span> <span class="string">/etc/nginx/conf.d</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 负载均衡高可用</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/keepalived</span>]<span class="comment">#tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">├──</span> <span class="string">files</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">keep_nginxcheck.sh</span></span><br><span class="line"><span class="string">├──</span> <span class="string">handlers</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">tasks</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">templates</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">keepalived.conf.j2</span></span><br><span class="line"><span class="string">└──</span> <span class="string">vars</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span> <span class="string">directories,</span> <span class="number">5</span> <span class="string">files</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/keepalived</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tasks file for keepalived</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Istall</span> <span class="string">keepalived</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">keepalived</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">shell</span> <span class="string">dir</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/script</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Sent</span> <span class="string">nginx</span> <span class="string">check</span> <span class="string">shell</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">keep_nginxcheck.sh</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/script</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">&#x27;0755&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">keepalived</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">keepalived.conf.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/keepalived/keepalived.conf</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">keepalived</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">keepalived</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">keepalived</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全网定时备份</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/backup</span>]<span class="comment">#tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">├──</span> <span class="string">files</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">backup.sh</span></span><br><span class="line"><span class="string">└──</span> <span class="string">tasks</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span> <span class="string">directories,</span> <span class="number">2</span> <span class="string">files</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/backup</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tasks file for backup</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">shell</span> <span class="string">dir</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/script/autobackup</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">not</span> <span class="string">match</span> <span class="string">&quot;backup&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Sent</span> <span class="string">backup.sh</span> <span class="string">all</span> <span class="string">except</span> <span class="string">backup</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">backup.sh</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/script/autobackup</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">&#x27;0755&#x27;</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">not</span> <span class="string">match</span> <span class="string">&quot;backup&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Write</span> <span class="string">in</span> <span class="string">cron</span> <span class="string">tasks</span> <span class="string">for</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">cron:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.name&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">minute:</span> <span class="string">&quot;*/5&quot;</span></span><br><span class="line">    <span class="comment">#hour: &quot;02&quot;</span></span><br><span class="line">    <span class="attr">job:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.job &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">&quot;Code scheduled backup&quot;</span>,<span class="attr">job:</span> <span class="string">/bin/bash</span> <span class="string">/script/autobackup/backup.sh</span> <span class="string">/code</span> <span class="string">&gt;</span> <span class="string">/dev/null</span> &#125;</span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">&quot;Nginx scheduled backup&quot;</span>,<span class="attr">job:</span> <span class="string">/bin/bash</span> <span class="string">/script/autobackup/backup.sh</span> <span class="string">/etc/nginx</span> <span class="string">&gt;</span> <span class="string">/dev/null</span> &#125;</span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Write</span> <span class="string">in</span> <span class="string">cron</span> <span class="string">tasks</span> <span class="string">for</span> <span class="string">lb</span></span><br><span class="line">  <span class="attr">cron:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;Nginx scheduled backup&quot;</span></span><br><span class="line">    <span class="attr">minute:</span> <span class="string">&quot;*/5&quot;</span></span><br><span class="line">    <span class="comment">#hour: &quot;02&quot;</span></span><br><span class="line">    <span class="attr">job:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/bash</span> <span class="string">/script/autobackup/backup.sh</span> <span class="string">/etc/nginx</span> <span class="string">&gt;</span> <span class="string">/dev/null</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;lb&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Write</span> <span class="string">in</span> <span class="string">cron</span> <span class="string">tasks</span> <span class="string">for</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">cron:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;Data share scheduled backup&quot;</span></span><br><span class="line">    <span class="attr">minute:</span> <span class="string">&quot;*/5&quot;</span></span><br><span class="line">    <span class="comment">#hour: &quot;02&quot;</span></span><br><span class="line">    <span class="attr">job:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/bash</span> <span class="string">/script/autobackup/backup.sh</span> <span class="string">/data</span> <span class="string">&gt;</span> <span class="string">/dev/null</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;nfs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Write</span> <span class="string">in</span> <span class="string">cron</span> <span class="string">tasks</span> <span class="string">for</span> <span class="string">db</span></span><br><span class="line">  <span class="attr">cron:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.name &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">minute:</span> <span class="string">&quot;*/5&quot;</span></span><br><span class="line">    <span class="comment">#hour: &quot;02&quot;</span></span><br><span class="line">    <span class="attr">job:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.job &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">&quot;Mysql conf scheduled backup&quot;</span>,<span class="attr">job:</span> <span class="string">/bin/bash</span> <span class="string">/script/autobackup/backup.sh</span> <span class="string">/etc/my.cnf.d</span> <span class="string">&gt;</span> <span class="string">/dev/null</span> &#125;</span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">&quot;Mysql file scheduled backup&quot;</span>,<span class="attr">job:</span> <span class="string">/bin/bash</span> <span class="string">/script/autobackup/backup.sh</span> <span class="string">/var/lib/mysql</span> <span class="string">&gt;</span> <span class="string">/dev/null</span> &#125;</span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;db&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置https</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/https</span>]<span class="comment">#tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">├──</span> <span class="string">files</span></span><br><span class="line"><span class="string">│</span>   <span class="string">├──</span> <span class="string">proxy.conf</span></span><br><span class="line"><span class="string">│</span>   <span class="string">├──</span> <span class="string">server.crt</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">server.key</span></span><br><span class="line"><span class="string">├──</span> <span class="string">handlers</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">tasks</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">templates</span></span><br><span class="line"><span class="string">└──</span> <span class="string">vars</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span> <span class="string">directories,</span> <span class="number">6</span> <span class="string">files</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/https</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tasks file for https</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">ssl_key</span> <span class="string">dir</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/nginx/ssl_key</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;lb&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Key</span> <span class="string">distribution</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/nginx/ssl_key</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">server.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">server.key</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;lb&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Modifying</span> <span class="string">agent</span> <span class="string">configuration</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">proxy.conf</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/nginx/conf.d</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;lb&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Modifying</span> <span class="string">web</span> <span class="string">configuration</span></span><br><span class="line">  <span class="attr">lineinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.path &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">regexp:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.regex &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">line:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.line &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">path:</span> <span class="string">/etc/nginx/conf.d/wordpress.conf</span>,<span class="attr">regex:</span> <span class="string">&#x27;^#fastcgi_param&#x27;</span>,<span class="attr">line:</span> <span class="string">&quot;fastcgi_param HTTPS on;&quot;</span> &#125;</span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">path:</span> <span class="string">/etc/nginx/conf.d/admin.conf</span>,<span class="attr">regex:</span> <span class="string">&#x27;^#fastcgi_param&#x27;</span>,<span class="attr">line:</span> <span class="string">&quot;fastcgi_param HTTPS on;&quot;</span> &#125;</span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">path:</span> <span class="string">/etc/nginx/conf.d/kod.conf</span>,<span class="attr">regex:</span> <span class="string">&#x27;^#fastcgi_param&#x27;</span>,<span class="attr">line:</span> <span class="string">&quot;fastcgi_param HTTPS on;&quot;</span> &#125;</span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">web</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">port</span> <span class="number">443</span> <span class="string">for</span> <span class="string">tomcat</span></span><br><span class="line">  <span class="attr">lineinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/soft/tomcat/conf/server.xml</span></span><br><span class="line">    <span class="attr">regexp:</span> <span class="string">&#x27;redirectPort=&quot;8443&quot;&#x27;</span></span><br><span class="line">    <span class="attr">line:</span> <span class="string">&#x27; redirectPort=&quot;443&quot; proxyPort=&quot;443&quot; scheme=&quot;https&quot; secure=&quot;true&quot; SSLEnabled=&quot;true&quot; &#x27;</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置防火墙策略</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/iptables</span>]<span class="comment">#tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">├──</span> <span class="string">tasks</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">└──</span> <span class="string">templates</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">iptables_strategy.j2</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span> <span class="string">directories,</span> <span class="number">2</span> <span class="string">files</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/iptables</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tasks file for iptables</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Stop</span> <span class="string">local</span> <span class="string">firewalld</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">firewalld</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">stopped</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Prohibit</span> <span class="string">self</span> <span class="string">start</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">systemctl</span> <span class="string">disable</span> <span class="string">firewalld</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">iptables-services</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">iptables-services</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">iptables</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">iptables.service</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Insert</span> <span class="string">configuration</span> <span class="string">in</span> <span class="string">rc.local</span></span><br><span class="line">  <span class="attr">blockinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/rc.d/rc.local</span></span><br><span class="line">    <span class="attr">block:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      modprobe ip_tables</span></span><br><span class="line"><span class="string">      modprobe iptable_filter</span></span><br><span class="line"><span class="string">      modprobe iptable_nat</span></span><br><span class="line"><span class="string">      modprobe ip_contrack</span></span><br><span class="line"><span class="string">      modprobe ip_conntrack_ftp</span></span><br><span class="line"><span class="string">      modprobe ip_nat_ftp</span></span><br><span class="line"><span class="string">      modprobe ipt_state</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Execute</span> <span class="string">permission</span> <span class="string">for</span> <span class="string">rc.local</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">chmod</span> <span class="number">0755</span> <span class="string">/etc/rc.d/rc.local</span> <span class="string">warn=false</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Sent</span> <span class="string">iptables_strategy</span> <span class="string">to</span> <span class="string">lb</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">iptables_strategy.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/tmp/iptables_strategy</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Import</span> <span class="string">iptables_strategy</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">iptables-restore</span> <span class="string">&lt;</span> <span class="string">/tmp/iptables_strategy</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Remove</span> <span class="string">/tmp/iptables_strategy</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/tmp/iptables_strategy</span> <span class="string">warn=false</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 内部服务器访问公网</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/access_net</span>]<span class="comment">#tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">└──</span> <span class="string">tasks</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="string">directory,</span> <span class="number">1</span> <span class="string">file</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/access_net</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tasks file for access_net</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Modifying</span> <span class="string">eth1</span> <span class="string">network</span> <span class="string">configuration</span></span><br><span class="line">  <span class="attr">blockinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/sysconfig/network-scripts/ifcfg-eth1</span></span><br><span class="line">    <span class="attr">block:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      GATEWAY=172.16.1.6</span></span><br><span class="line"><span class="string"></span>  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">not</span> <span class="string">match</span> <span class="string">&quot;lb&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">the</span> <span class="string">network</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">systemctl</span> <span class="string">restart</span> <span class="string">network</span> <span class="string">warn=false</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">not</span> <span class="string">match</span> <span class="string">&quot;lb&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">switch</span> <span class="string">on</span> <span class="string">kernel</span> <span class="string">forward</span></span><br><span class="line">  <span class="attr">blockinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/sysctl.conf</span></span><br><span class="line">    <span class="attr">block:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string"></span>  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;lb&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">load</span> <span class="string">configuration</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">sysctl</span> <span class="string">-p</span> <span class="string">warn=false</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;lb&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#- name: switch off eth0</span></span><br><span class="line"><span class="comment">#  shell: ifdown eth0 warn=false</span></span><br><span class="line"><span class="comment">#  when: ansible_hostname is not match &quot;lb&quot;</span></span><br><span class="line"><span class="comment">#- name: Modifying eth0 network configuration</span></span><br><span class="line"><span class="comment">#  lineinfile:</span></span><br><span class="line"><span class="comment">#    path: /etc/sysconfig/network-scripts/ifcfg-eth0</span></span><br><span class="line"><span class="comment">#    regexp: &#x27;^ONBOOT&#x27;</span></span><br><span class="line"><span class="comment">#    line: &#x27;ONBOOT=yes&#x27;</span></span><br><span class="line"><span class="comment">#  when: ansible_hostname is not match &quot;lb&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 时间服务器配置</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/ntpdate</span>]<span class="comment">#tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">├──</span> <span class="string">handlers</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">└──</span> <span class="string">tasks</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span> <span class="string">directories,</span> <span class="number">2</span> <span class="string">files</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/ntpdate</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tasks file for ntpdata</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">ntp</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ntp</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">cron</span> <span class="string">task</span> <span class="string">in</span> <span class="string">server</span></span><br><span class="line">  <span class="attr">cron:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;TimeSync as Server&quot;</span></span><br><span class="line">    <span class="attr">minute:</span> <span class="string">&quot;*/10&quot;</span></span><br><span class="line">    <span class="attr">job:</span> <span class="string">&quot;/usr/sbin/ntpdate ntp1.aliyun.com &amp;&amp; hwclock -w &gt; /dev/null&quot;</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">not</span> <span class="string">match</span> <span class="string">&quot;nfs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Modifying</span> <span class="string">configure</span> <span class="string">for</span> <span class="string">server</span></span><br><span class="line">  <span class="attr">blockinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/ntp.conf</span></span><br><span class="line">    <span class="attr">block:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      SYNC_HWCLOCK=yes</span></span><br><span class="line"><span class="string"></span>  <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">ntpd</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">not</span> <span class="string">match</span> <span class="string">&quot;nfs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Remove</span> <span class="string">server</span> <span class="string">on</span> <span class="string">client</span></span><br><span class="line">  <span class="attr">lineinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/ntp.conf</span></span><br><span class="line">    <span class="attr">regexp:</span> <span class="string">&#x27;^server&#x27;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">not</span> <span class="string">match</span> <span class="string">&quot;nfs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Modifying</span> <span class="string">configure</span> <span class="string">for</span> <span class="string">client</span></span><br><span class="line">  <span class="attr">blockinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/ntp.conf</span></span><br><span class="line">    <span class="attr">block:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      server 172.16.1.32 prefer</span></span><br><span class="line"><span class="string">      server 172.16.1.31</span></span><br><span class="line"><span class="string"></span>  <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">ntpd</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">not</span> <span class="string">match</span> <span class="string">&quot;nfs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">ntpd</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ntpd</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">cron</span> <span class="string">task</span> <span class="string">in</span> <span class="string">client</span></span><br><span class="line">  <span class="attr">cron:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;TimeSync as Server&quot;</span></span><br><span class="line">    <span class="attr">minute:</span> <span class="string">&quot;*/10&quot;</span></span><br><span class="line">    <span class="attr">job:</span> <span class="string">&quot;/usr/sbin/ntpdate 172.16.1.32 &amp;&amp; hwclock -w &gt; /dev/null&quot;</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">not</span> <span class="string">match</span> <span class="string">&quot;nfs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;Ansible一键部署实例（三）&lt;/center&gt;&lt;/h1&gt;
&lt;table&gt;&lt;tr&gt;&lt;td bgcolor=#000000&gt;&lt;font color=&quot;white&quot;&gt;业务部署代码&lt;/font&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# wordpress业务部署&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[&lt;span class=&quot;string&quot;&gt;root@ansible&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;~/roles/wordpress&lt;/span&gt;]&lt;span class=&quot;comment&quot;&gt;#tree&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;├──&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;files&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;│&lt;/span&gt;   &lt;span class=&quot;string&quot;&gt;├──&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;wordpress.conf&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;│&lt;/span&gt;   &lt;span class=&quot;string&quot;&gt;├──&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;wordpress.sql&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;│&lt;/span&gt;   &lt;span class=&quot;string&quot;&gt;└──&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;wordpress.tar.gz&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;├──&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;handlers&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;│&lt;/span&gt;   &lt;span class=&quot;string&quot;&gt;└──&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;main.yml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;├──&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;tasks&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;│&lt;/span&gt;   &lt;span class=&quot;string&quot;&gt;└──&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;main.yml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;├──&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;templates&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;└──&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;vars&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;└──&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;main.yml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;directories,&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;6&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;files&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[&lt;span class=&quot;string&quot;&gt;root@ansible&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;~/roles/wordpress&lt;/span&gt;]&lt;span class=&quot;comment&quot;&gt;#cat tasks/main.yml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# tasks file for wordpress&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;remove&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;nginx&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;default.conf&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;shell:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;rm&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;-rf&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;/etc/nginx/conf.d/default.conf&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;warn=false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;when:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;ansible_hostname&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;web&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;configure&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;wordpress&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;nginx&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;server&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;copy:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;src:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;wordpress.conf&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;dest:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;/etc/nginx/conf.d&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;notify:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;restart&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;web&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;nginx&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;when:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;ansible_hostname&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;web&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;wordpress&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;code&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;dir&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;file:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;path:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;/code/wordpress&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;owner:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;www&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;group:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;www&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;state:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;directory&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;when:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;ansible_hostname&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;web&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;Extract&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;wordpress.tar.gz&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;into&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;web&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;/code&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;unarchive:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;src:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;wordpress.tar.gz&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;dest:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;/code/wordpress&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;when:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;ansible_hostname&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;web&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;Modify&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;directory&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;permissions&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;shell:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;chown&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;-R&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;www.www&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;/code&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;warn=false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;when:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;ansible_hostname&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;web&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;sent&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;wordpress.sql&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;db&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;copy:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;src:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;wordpress.sql&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;dest:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;/tmp&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;when:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;ansible_hostname&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;db&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;wordpress.sql&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;mysql_db:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;all&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;state:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;import&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;target:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;/tmp/wordpress.sql&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;register:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;result&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;when:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;ansible_hostname&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;db&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;restart&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;nginx&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;service&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;systemd:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;nginx&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;state:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;restarted&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;when:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;ansible_hostname&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;web&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;restart&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;mariadb&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;service&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;systemd:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;mariadb&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;state:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;restarted&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;when:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;ansible_hostname&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;db&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;mount&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;dir&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;nfs1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;mount:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;src:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;172.16&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.1&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.31&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;:/data/wordpress&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;path:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;/code/wordpress/wp-content/uploads&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;fstype:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;nfs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;state:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;mounted&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;when:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;ansible_hostname&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;web&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="服务架构" scheme="https://smallflames.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>Ansible一键部署实例（二）</title>
    <link href="https://smallflames.github.io/2024/01/21/Ansible%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2%E5%AE%9E%E4%BE%8B%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <id>https://smallflames.github.io/2024/01/21/Ansible%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2%E5%AE%9E%E4%BE%8B%EF%BC%88%E4%BA%8C%EF%BC%89/</id>
    <published>2024-01-21T10:35:40.000Z</published>
    <updated>2024-01-21T11:35:06.680Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>Ansible一键部署实例（二）</center></h1><table><tr><td bgcolor=#000000><font color="white">基本环境准备</font></td></tr></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 免密钥分发</span></span><br><span class="line">[root@ansible ~/roles]<span class="comment">#cat ssh.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">key=<span class="string">&quot;/root/.ssh/id_rsa.pub&quot;</span></span><br><span class="line">pass=<span class="string">&quot;密码&quot;</span></span><br><span class="line">nodeip=<span class="string">&quot;ipfile&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> ip</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    sshpass -p <span class="variable">$pass</span> ssh-copy-id -i <span class="variable">$key</span> <span class="variable">$ip</span> -o StrictHostKeyChecking=no &amp;&gt; /dev/null &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;ip&#125;</span> sshkey is success.&quot;</span></span><br><span class="line"><span class="keyword">done</span> &lt; <span class="variable">$nodeip</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ipfile</span></span><br><span class="line">[root@ansible ~/roles]<span class="comment">#cat ipfile</span></span><br><span class="line">172.16.1.5</span><br><span class="line">172.16.1.6</span><br><span class="line">172.16.1.7</span><br><span class="line">172.16.1.8</span><br><span class="line">172.16.1.9</span><br><span class="line">172.16.1.51</span><br><span class="line">172.16.1.31</span><br><span class="line">172.16.1.32</span><br><span class="line">172.16.1.41</span><br><span class="line"></span><br><span class="line"><span class="comment"># hosts</span></span><br><span class="line">[root@ansible ~/roles]<span class="comment">#cat hosts</span></span><br><span class="line">[web]</span><br><span class="line">172.16.1.7</span><br><span class="line">172.16.1.8</span><br><span class="line">172.16.1.9</span><br><span class="line">[nfs]</span><br><span class="line">172.16.1.31</span><br><span class="line">172.16.1.32</span><br><span class="line">[db]</span><br><span class="line">172.16.1.51</span><br><span class="line">[lb]</span><br><span class="line">172.16.1.5</span><br><span class="line">172.16.1.6</span><br><span class="line">[backup]</span><br><span class="line">172.16.1.41</span><br></pre></td></tr></table></figure><span id="more"></span><table><tr><td bgcolor=#000000><font color="white">全局部署文件</font></td></tr></table><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles</span>]<span class="comment">#cat site.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">The</span> <span class="string">configuration</span> <span class="string">of</span> <span class="string">this</span> <span class="string">script</span> <span class="string">is</span> <span class="string">as</span> <span class="string">follows</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">basic</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">basic</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">local_repo</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">local_repo</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">rsync</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">rsync</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">nfs</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">nfs</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">(ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span><span class="string">)</span> <span class="string">or</span> <span class="string">(ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;nfs&quot;</span><span class="string">)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">php</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">php</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">mysql</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">mysql</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;db&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">sersync</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">sersync</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;nfs&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">global_nginx</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">global_nginx</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">(ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;lb&quot;</span><span class="string">)</span> <span class="string">or</span> <span class="string">(ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span><span class="string">)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">kod</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">kod</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">tomcat</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">tomcat</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">zrlog</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">zrlog</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">phpadmin</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">phpadmin</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">lb_nginx</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">lb_nginx</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;lb&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">keepalived</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">keepalived</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;lb&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">backup</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">backup</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">(ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;lb&quot;</span><span class="string">)</span> <span class="string">or</span> <span class="string">(ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;web&quot;</span><span class="string">)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">iptables</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">iptables</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;lb&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">access_net</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">access_net</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">ntpdate</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">ntpdate</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><table><tr><td bgcolor=#000000><font color="white">基础优化项</font></td></tr></table><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为各项服务统一用户准备</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/basic</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nified</span> <span class="string">Users</span> <span class="string">create</span> <span class="string">www</span> <span class="string">group</span></span><br><span class="line">  <span class="attr">group:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">gid:</span> <span class="number">666</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">www</span> <span class="string">user</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="number">666</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">create_home:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><table><tr><td bgcolor=#000000><font color="white">服务环境搭建</font></td></tr></table><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置本地YUM仓库</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/local_repo</span>]<span class="comment">#tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">├──</span> <span class="string">files</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">soft.repo</span></span><br><span class="line"><span class="string">└──</span> <span class="string">tasks</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span> <span class="string">directories,</span> <span class="number">2</span> <span class="string">files</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/local_repo</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tasks file for local_repo</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">repo</span> <span class="string">dir</span> <span class="string">for</span> <span class="string">backup</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/repo</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Mv</span> <span class="string">repo</span> <span class="string">to</span> <span class="string">backupdir</span> <span class="string">/repo</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">mv</span> <span class="string">/etc/yum.repos.d/*</span> <span class="string">/repo</span> <span class="string">warn=false</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">local</span> <span class="string">yum</span> <span class="string">repo</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">soft.repo</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/yum.repos.d</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#- name: Install yum-plugin-priorities</span></span><br><span class="line"><span class="comment">#  yum:</span></span><br><span class="line"><span class="comment">#    name: yum-plugin-priorities</span></span><br><span class="line"><span class="comment">#    state: present</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#- name: Mv repo to backupdir /repo</span></span><br><span class="line"><span class="comment">#  shell: mv /repo/* /etc/yum.repos.d warn=false</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装配置rsync服务</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/rsync</span>]<span class="comment">#tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">├──</span> <span class="string">files</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">rsyncd.conf</span></span><br><span class="line"><span class="string">├──</span> <span class="string">handlers</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">tasks</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">templates</span></span><br><span class="line"><span class="string">└──</span> <span class="string">vars</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span> <span class="string">directories,</span> <span class="number">4</span> <span class="string">files</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/rsync</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tasks file for rsync</span></span><br><span class="line"><span class="comment"># backup为服务端，其余全部为客户端</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">rsync</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">rsync</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">configure</span> <span class="string">rsync</span> <span class="string">server</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">rsyncd.conf</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;backup&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">backup</span> <span class="string">dir</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">    <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/backup/lb</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/backup/web</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/backup/nfs</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/backup/msq</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;backup&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">passwd</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">content:</span> <span class="string">rsync_backup:nanxi</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/rsync.passwd</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="number">0600</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">rsync</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;backup&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">rsync</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">rsyncd</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;backup&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">configure</span> <span class="string">rsync</span> <span class="string">client</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">content:</span> <span class="string">nanxi</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/rsync.pass</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="number">0600</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">not</span> <span class="string">match</span> <span class="string">&quot;backup&quot;</span></span><br><span class="line"><span class="comment"># nfs2为服务端，nfs1为客户端</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs2</span> <span class="string">configure</span> <span class="string">rsync</span> <span class="string">server</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">rsyncd.conf</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;nfs2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs2</span> <span class="string">create</span> <span class="string">backup</span> <span class="string">dir</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/backup/nfs</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">    <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;nfs2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs2</span> <span class="string">create</span> <span class="string">passwd</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">content:</span> <span class="string">rsync_backup:nanxi</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/rsync.passwd</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="number">0600</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;nfs2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">rsync</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">rsyncd</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;nfs2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs2</span> <span class="string">start</span> <span class="string">rsync</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">rsyncd</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;nfs2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装nfs服务</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/nfs</span>]<span class="comment">#tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">├──</span> <span class="string">files</span></span><br><span class="line"><span class="string">├──</span> <span class="string">handlers</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">tasks</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">templates</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">exports.j2</span></span><br><span class="line"><span class="string">└──</span> <span class="string">vars</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span> <span class="string">directories,</span> <span class="number">4</span> <span class="string">files</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/nfs</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tasks file for nfs</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">nfs</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-utils</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">nfs</span> <span class="string">share</span> <span class="string">dir</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kod</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">zrlog</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">phpadmin</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;nfs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">configure</span> <span class="string">nfs</span> <span class="string">servser</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">exports.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/exports</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">nfs</span> <span class="string">server</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;nfs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">nfs</span> <span class="string">server</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">rpcbind</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nfs-server</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;nfs&quot;</span></span><br><span class="line">  </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装配置PHP服务</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/php</span>]<span class="comment">#tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">├──</span> <span class="string">files</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">php.tar.gz</span></span><br><span class="line"><span class="string">├──</span> <span class="string">handlers</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">tasks</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">templates</span></span><br><span class="line"><span class="string">└──</span> <span class="string">vars</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span> <span class="string">directories,</span> <span class="number">4</span> <span class="string">files</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/php</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tasks file for php</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Extract</span> <span class="string">php.tar.gz</span> <span class="string">into</span> <span class="string">web</span> <span class="string">/tmp</span></span><br><span class="line">  <span class="attr">unarchive:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">php.tar.gz</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/tmp</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">php</span> <span class="string">into</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">yum</span> <span class="string">-y</span> <span class="string">localinstall</span> <span class="string">/tmp/*.rpm</span> <span class="string">warn=false</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">remove</span> <span class="string">php.*.rpm</span> <span class="string">in</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/tmp/*.rpm</span> <span class="string">warn=false</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">configure</span> <span class="string">php</span> <span class="string">start</span> <span class="string">user</span> <span class="string">and</span> <span class="string">prepare</span> <span class="string">for</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">lineinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/php-fpm.d/www.conf</span></span><br><span class="line">    <span class="attr">regexp:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.regex &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">line:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.line &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">php-fpm</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">regex:</span> <span class="string">&#x27;^user&#x27;</span>,<span class="attr">line:</span> <span class="string">user</span> <span class="string">=</span> <span class="string">www</span> &#125;</span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">regex:</span> <span class="string">&#x27;^group&#x27;</span>,<span class="attr">line:</span> <span class="string">group</span> <span class="string">=</span> <span class="string">www</span> &#125;</span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">regex:</span> <span class="string">&#x27;^php_value\[session.save_handler\]&#x27;</span>,<span class="attr">line:</span> <span class="string">&quot;;php_value[session.save_handler] = files&quot;</span> &#125;</span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">regex:</span> <span class="string">&#x27;^php_value\[session.save_path\]&#x27;</span>,<span class="attr">line:</span> <span class="string">&quot;;php_value[session.save_path] = /var/lib/php/session&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">configure</span> <span class="string">php</span> <span class="string">for</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">lineinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/php.ini</span></span><br><span class="line">    <span class="attr">regexp:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.regex &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">line:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.line &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">php-fpm</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">regex:</span> <span class="string">&#x27;^session\.save_handler&#x27;</span>,<span class="attr">line:</span> <span class="string">session.save_handler</span> <span class="string">=</span> <span class="string">redis</span> &#125;</span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">regex:</span> <span class="string">&#x27;^session\.save_path&#x27;</span>,<span class="attr">line:</span> <span class="string">&#x27;session.save_path = &quot;tcp://172.16.1.51:6379&quot;&#x27;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">php-fpm</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">php-fpm</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装数据库、redis及依赖</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/mysql</span>]<span class="comment">#tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">├──</span> <span class="string">files</span></span><br><span class="line"><span class="string">├──</span> <span class="string">handlers</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">tasks</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">templates</span></span><br><span class="line"><span class="string">└──</span> <span class="string">vars</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span> <span class="string">directories,</span> <span class="number">3</span> <span class="string">files</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/mysql</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tasks file for mysql</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">mariadb</span> <span class="string">Server</span> <span class="string">redis</span> <span class="string">and</span> <span class="string">dependent</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mariadb-server</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">MySQL-python</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">configure</span> <span class="string">/etc/redis.conf</span></span><br><span class="line">  <span class="attr">lineinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/redis.conf</span></span><br><span class="line">    <span class="attr">regexp:</span> <span class="string">&#x27;^bind&#x27;</span></span><br><span class="line">    <span class="attr">line:</span> <span class="string">bind</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">mysql</span> <span class="string">and</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mariadb</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为nfs配置sersync服务</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/sersync</span>]<span class="comment">#tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">├──</span> <span class="string">files</span></span><br><span class="line"><span class="string">│</span>   <span class="string">├──</span> <span class="string">confxml.xml</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">sersync2</span></span><br><span class="line"><span class="string">├──</span> <span class="string">tasks</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">└──</span> <span class="string">templates</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span> <span class="string">directories,</span> <span class="number">3</span> <span class="string">files</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/sersync</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tasks file for sersync</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Cteate</span> <span class="string">sersync</span> <span class="string">dir</span> <span class="string">in</span> <span class="string">nfs1</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/sersync</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;nfs1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Sent</span> <span class="string">sersync</span> <span class="string">to</span> <span class="string">nfs1</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/sersync</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">&#x27;0755&#x27;</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">confxml.xml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sersync2</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;nfs1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Modify</span> <span class="string">backup</span> <span class="string">module</span> <span class="string">in</span> <span class="string">nfs2</span></span><br><span class="line">  <span class="attr">lineinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/rsyncd.conf</span></span><br><span class="line">    <span class="attr">regexp:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.regex &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">line:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.line &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">regex:</span> <span class="string">&#x27;^\[backup\]&#x27;</span>,<span class="attr">line:</span> <span class="string">&quot;[data]&quot;</span> &#125;</span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">regex:</span> <span class="string">&#x27;^path&#x27;</span>,<span class="attr">line:</span> <span class="string">path</span> <span class="string">=</span> <span class="string">/data</span> &#125;</span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;nfs2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">rsync</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">rsyncd</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;nfs2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">sersync</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">shell:</span></span><br><span class="line">    <span class="attr">cmd:</span> <span class="string">/etc/sersync/sersync2</span> <span class="string">-dro</span> <span class="string">/etc/sersync/confxml.xml</span></span><br><span class="line">  <span class="attr">ignore_errors:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">&quot;nfs1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置官方nginx服务</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/global_nginx</span>]<span class="comment">#tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">├──</span> <span class="string">files</span></span><br><span class="line"><span class="string">├──</span> <span class="string">handlers</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">tasks</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"><span class="string">├──</span> <span class="string">templates</span></span><br><span class="line"><span class="string">└──</span> <span class="string">vars</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span> <span class="string">directories,</span> <span class="number">3</span> <span class="string">files</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~/roles/global_nginx</span>]<span class="comment">#cat tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tasks file for nginx</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">nginx</span> <span class="string">official</span> <span class="string">yum</span></span><br><span class="line">  <span class="attr">yum_repository:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx-stable</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">nginx</span> <span class="string">yum</span> <span class="string">repo</span></span><br><span class="line">    <span class="attr">baseurl:</span> <span class="string">http://nginx.org/packages/centos/$releasever/$basearch/</span></span><br><span class="line">    <span class="attr">gpgcheck:</span> <span class="literal">no</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">official</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">unified</span> <span class="string">users</span> <span class="string">by</span> <span class="string">www</span></span><br><span class="line">  <span class="attr">lineinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">    <span class="attr">regexp:</span> <span class="string">&#x27;^user&#x27;</span></span><br><span class="line">    <span class="attr">line:</span> <span class="string">user</span> <span class="string">www;</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;Ansible一键部署实例（二）&lt;/center&gt;&lt;/h1&gt;
&lt;table&gt;&lt;tr&gt;&lt;td bgcolor=#000000&gt;&lt;font color=&quot;white&quot;&gt;基本环境准备&lt;/font&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 免密钥分发&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[root@ansible ~/roles]&lt;span class=&quot;comment&quot;&gt;#cat ssh.sh&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#!/bin/bash&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;key=&lt;span class=&quot;string&quot;&gt;&amp;quot;/root/.ssh/id_rsa.pub&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pass=&lt;span class=&quot;string&quot;&gt;&amp;quot;密码&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nodeip=&lt;span class=&quot;string&quot;&gt;&amp;quot;ipfile&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;read&lt;/span&gt; ip&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    sshpass -p &lt;span class=&quot;variable&quot;&gt;$pass&lt;/span&gt; ssh-copy-id -i &lt;span class=&quot;variable&quot;&gt;$key&lt;/span&gt; &lt;span class=&quot;variable&quot;&gt;$ip&lt;/span&gt; -o StrictHostKeyChecking=no &amp;amp;&amp;gt; /dev/null &amp;amp;&amp;amp; &lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;&lt;span class=&quot;variable&quot;&gt;$&amp;#123;ip&amp;#125;&lt;/span&gt; sshkey is success.&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;done&lt;/span&gt; &amp;lt; &lt;span class=&quot;variable&quot;&gt;$nodeip&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# ipfile&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[root@ansible ~/roles]&lt;span class=&quot;comment&quot;&gt;#cat ipfile&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.16.1.5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.16.1.6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.16.1.7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.16.1.8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.16.1.9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.16.1.51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.16.1.31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.16.1.32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.16.1.41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# hosts&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[root@ansible ~/roles]&lt;span class=&quot;comment&quot;&gt;#cat hosts&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[web]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.16.1.7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.16.1.8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.16.1.9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[nfs]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.16.1.31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.16.1.32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[db]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.16.1.51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[lb]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.16.1.5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.16.1.6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[backup]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172.16.1.41&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="服务架构" scheme="https://smallflames.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>Ansible一键部署实例（一）</title>
    <link href="https://smallflames.github.io/2024/01/21/Ansible%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2%E5%AE%9E%E4%BE%8B%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>https://smallflames.github.io/2024/01/21/Ansible%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2%E5%AE%9E%E4%BE%8B%EF%BC%88%E4%B8%80%EF%BC%89/</id>
    <published>2024-01-21T09:25:32.000Z</published>
    <updated>2024-01-21T15:04:35.484Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>Ansible一键部署实例（一）</center></h1><p>  我们今天要用Ansible实现一键部署的框架大致如下：</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240121173432410.png" alt="image-20240121173432410"></p><p>  南汐在这里对本次框架做一个简单的介绍，这是一个非常基础的架构，虽然可能不如实际应用中的复杂，但是麻雀虽小，亦五脏俱全。从用户角度来看，当我们的用户访问我们公司的网站时，一般情况下会经由DNS智能调度系统给用户返回距离用户地域距离最近的服务器地址，这就是我们的CDN服务器，它会默认存储我们web服务上基本所有的静态资源（或动态内容、流媒体文件）以提高用户的访问体验，如果CDN上没有用户所请求的资源，此时会出现回源。<span id="more"></span>当我们的用户直接访问源站的时候，会经由我们前端的网络防火墙过滤非法流量，然会到达我们的负载，本次架构中我们使用两台服务器应用NGINX作为负载均衡，并在两台服务器之间通过keepalived实现高可用。请求经由负载均衡的调度算法后转发至我们真实的web服务器，这里web服务器在实际中基本都是多节点的，我们称之集群，南汐这里使用三台服务器来进行模拟。web端的静态文件由后端的两台NFS服务器存储，他们之间的数据实时同步的，并且具备高可用，以避免单点故障，同时前端所产生的业务数据数据库文件都会存放在后端的数据库。最后与业务直接相关的服务器（本此架构中有8台）均会定时将重要文件备份至backup服务器。从运维管理人员的角度来看，我们会经由VPN进入公司的jumpserver服务器（直接越过用户路径的防火墙进入内部），底层通过Ansible自动化管理工具来对公司的服务器进行管理，监控和维护。为了提高脚本安装服务的执行效率，我们额外搭建了一个本地仓库为提供内部局域网安装服务使用。</p><p>  （南汐并没有实现架构内的所有功能，本次展示只为帮助大家提高对Ansible自动化管理工具的应用）详细Playbook角色分布如下：</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240121182411299.png" alt="image-20240121182411299"></p><p>  接下来南汐会用几篇文章依次开放源码展示，大家仅供参考，可自行实践练习……</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;Ansible一键部署实例（一）&lt;/center&gt;&lt;/h1&gt;
&lt;p&gt;  我们今天要用Ansible实现一键部署的框架大致如下：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240121173432410.png&quot; alt=&quot;image-20240121173432410&quot;&gt;&lt;/p&gt;
&lt;p&gt;  南汐在这里对本次框架做一个简单的介绍，这是一个非常基础的架构，虽然可能不如实际应用中的复杂，但是麻雀虽小，亦五脏俱全。从用户角度来看，当我们的用户访问我们公司的网站时，一般情况下会经由DNS智能调度系统给用户返回距离用户地域距离最近的服务器地址，这就是我们的CDN服务器，它会默认存储我们web服务上基本所有的静态资源（或动态内容、流媒体文件）以提高用户的访问体验，如果CDN上没有用户所请求的资源，此时会出现回源。</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="服务架构" scheme="https://smallflames.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>Ansible Jinja2模板</title>
    <link href="https://smallflames.github.io/2024/01/04/Jinja2%E6%A8%A1%E6%9D%BF/"/>
    <id>https://smallflames.github.io/2024/01/04/Jinja2%E6%A8%A1%E6%9D%BF/</id>
    <published>2024-01-04T12:49:49.000Z</published>
    <updated>2024-01-04T13:22:34.674Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>Ansible Jinja2模板</center></h1><p>  如果我们的需求是在100台主机上安装nginx，每台nginx的端口都不一样，我们如何解决呢？很棘手的问题，但是jinja2可以，Ansible通常会使用jinja2模板来修改被管理主机的配置文件，尤其在批量修改多台主机的配置文件时，很便捷。Jinja2文件后缀通常为.j2，是一个里面包含变量的模板文件，使用template模块调用。<font color="gray"><em>（template模块和copy模块一样，都是将文件复制到远端主机上去，区别在于template模块可以获取到文件中的变量，而copy则是原封不动的把文件内容复制过去）</em></font></p><span id="more"></span><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]#cat keepalived.j2</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id &#123;&#123; ansible_fqdn &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">&#123;% if ansible_fqdn == &quot;web01&quot; %&#125;</span><br><span class="line">    state MASTER</span><br><span class="line">    priority 150</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">    state BACKUP</span><br><span class="line">    priority 100</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 50</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;         </span><br><span class="line">        1.1.1.1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240104211506521.png" alt="image-20240104211506521"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240104211849054.png" alt="image-20240104211849054"></p><blockquote><p>Ansible允许jinja2模板中使用条件判断和循环，但是不允许在playbook中使用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#循环表达式</span></span><br><span class="line">&#123;% <span class="keyword">for</span> i <span class="keyword">in</span> EXPR %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#条件判断</span></span><br><span class="line">&#123;% <span class="keyword">if</span> EXPR %&#125;</span><br><span class="line">&#123;% <span class="keyword">elif</span> EXPR %&#125;</span><br><span class="line">&#123;% <span class="keyword">else</span> %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#注释</span></span><br><span class="line">&#123;<span class="comment"># COMMENT #&#125;</span></span><br></pre></td></tr></table></figure></blockquote><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;Ansible Jinja2模板&lt;/center&gt;&lt;/h1&gt;
&lt;p&gt;  如果我们的需求是在100台主机上安装nginx，每台nginx的端口都不一样，我们如何解决呢？很棘手的问题，但是jinja2可以，Ansible通常会使用jinja2模板来修改被管理主机的配置文件，尤其在批量修改多台主机的配置文件时，很便捷。Jinja2文件后缀通常为.j2，是一个里面包含变量的模板文件，使用template模块调用。&lt;font color=&quot;gray&quot;&gt;&lt;em&gt;（template模块和copy模块一样，都是将文件复制到远端主机上去，区别在于template模块可以获取到文件中的变量，而copy则是原封不动的把文件内容复制过去）&lt;/em&gt;&lt;/font&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="服务架构" scheme="https://smallflames.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>Ansible流程控制</title>
    <link href="https://smallflames.github.io/2024/01/04/Ansible%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/"/>
    <id>https://smallflames.github.io/2024/01/04/Ansible%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/</id>
    <published>2024-01-04T10:42:51.000Z</published>
    <updated>2024-01-04T12:37:44.110Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>Ansible流程控制</center></h1><p>  不管是shell还是各大编程语言中，流程控制、条件判断、循环这些都是必不可少的，在我们使用Ansible的过程中，条件判断的使用频率同样极其的高，是我们必须掌握的技能。</p><h2 id="一、when判断">一、when判断</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webs</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span>  <span class="string">when</span> <span class="string">ceshi</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">htop</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">tree</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">==</span> <span class="string">&quot;web01&quot;</span>   <span class="comment">### 当主机名为web01时执行本条任务</span></span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240104191250989.png" alt="image-20240104191250989"></p><span id="more"></span><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">when判断语法:</span><br><span class="line">when: ansible_hostname == <span class="string">&quot;web01&quot;</span>        <span class="comment"># 完全匹配</span></span><br><span class="line">when: ansible_hostname != <span class="string">&quot;web01&quot;</span>     <span class="comment"># 取反,当主机名不为web01时使用</span></span><br><span class="line">when: ansible_hostname is not match <span class="string">&quot;web01&quot;</span> <span class="comment"># 同上</span></span><br><span class="line">when: ansible_hostname is match <span class="string">&quot;web&quot;</span>    <span class="comment"># 匹配主机名包含web的客户端</span></span><br><span class="line">when: ansible_hostname is search <span class="string">&quot;web&quot;</span>   <span class="comment"># 搜索主机名包含web的客户端</span></span><br><span class="line"> </span><br><span class="line">when: ansible_default_ipv4.address is  match <span class="string">&quot;10.0.0.7&quot;</span>  <span class="comment"># 匹配IP地址</span></span><br><span class="line">when: (ansible_default_ipv4.address is  match <span class="string">&quot;10.0.0.7&quot;</span>) or (ansible_hostname == <span class="string">&quot;web02&quot;</span>)      <span class="comment"># 或者</span></span><br><span class="line">(ansible_default_ipv4.address is  match <span class="string">&quot;10.0.0.7&quot;</span>) and (ansible_hostname == <span class="string">&quot;web02&quot;</span>) <span class="comment"># 并且</span></span><br><span class="line">when:  <span class="comment"># 并且关系</span></span><br><span class="line">  - ansible_default_ipv4.address is  match <span class="string">&quot;10.0.0.7&quot;</span> </span><br><span class="line">  - ansible_hostname == <span class="string">&quot;web02&quot;</span></span><br><span class="line">when: ansible_facts.distribution_major_version &gt; <span class="string">&quot;6&quot;</span>  <span class="comment"># 使用数字进行判断比较</span></span><br></pre></td></tr></table></figure><p>案例. 根据nginx的返回结果来判断是否重启nginx</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webs</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">install</span> <span class="string">web</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span> <span class="string">offical</span> <span class="string">yum</span></span><br><span class="line">      <span class="attr">yum_repository:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">nginx</span> <span class="string">stable</span> <span class="string">repo</span></span><br><span class="line">        <span class="attr">gpgcheck:</span> <span class="literal">no</span></span><br><span class="line">        <span class="attr">baseurl:</span> <span class="string">http://nginx.org/packages/centos/$releasever/$basearch/</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">configer</span> <span class="string">nginx.conf</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./nginx.conf</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">nginx</span> <span class="string">syntax</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">nginx</span> <span class="string">-t</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">result</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">systemd:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">result</span> <span class="string">is</span> <span class="string">search</span> <span class="string">&quot;ok&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ansible_hostname</span> <span class="string">==</span> <span class="string">&quot;web01&quot;</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240104192956127.png" alt="image-20240104192956127"></p><h2 id="二、字典循环">二、字典循环</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 注意：item是固定的变量名称，不能自定义</span></span><br><span class="line"><span class="comment">### 有了item变量，我们就可以字典循环一次安装多个服务,有很高的可拓展性</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webs</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span>  <span class="string">loop</span> <span class="string">ceshi</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.name &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.owner &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.group &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.mode &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">touch</span></span><br><span class="line">      <span class="attr">loop:</span></span><br><span class="line">        <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="number">1.</span><span class="string">txt</span>,<span class="attr">owner:</span> <span class="string">root</span>,<span class="attr">group:</span> <span class="string">root</span>,<span class="attr">mode:</span> <span class="string">&#x27;0666&#x27;</span> &#125;</span><br><span class="line">        <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="number">2.</span><span class="string">txt</span>,<span class="attr">owner:</span> <span class="string">www</span>,<span class="attr">group:</span> <span class="string">www</span>,<span class="attr">mode:</span> <span class="string">&#x27;0600&#x27;</span> &#125;</span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">==</span> <span class="string">&quot;web01&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240104194111250.png" alt="image-20240104194111250"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]<span class="comment">#ll</span></span><br><span class="line">total 0</span><br><span class="line">-rw-rw-rw- 1 root root 0 Jan  4 19:40 1.txt</span><br><span class="line">-rw------- 1 www  www  0 Jan  4 19:40 2.txt</span><br></pre></td></tr></table></figure><h2 id="三、handlers事件触发模块">三、handlers事件触发模块</h2><p><strong>同样以安装nginx为例，根据配置文件是否修改来触发是否重启nginx</strong></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240104200922643.png" alt="image-20240104200922643"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240104200156161.png" alt="image-20240104200156161"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240104200053928.png" alt="image-20240104200053928"></p><div class="warning"><p><strong>handlers模块使用注意事项</strong></p><ol><li class="lvl-3">无论多少个task通知了相同的handlers，handlers仅会在所有tasks结束后运行一次；</li><li class="lvl-3">handlers只有在其所在的任务被执行时，才会被运行；</li><li class="lvl-3">handlers只会在每一个play的末尾运行一次，想在一个playbook中间运行handlers，则需要使用meta模块来实现，如： <code>-meta: flush_handlers</code> ；</li><li class="lvl-3">不能使用handlers替代tasks，handlers和tasks是同级的，在handlers下写的任务只用被调用才能运行</li></ol></div><h2 id="四、playbook文件复用">四、playbook文件复用</h2><blockquote><p>一个yaml文件执行（引用）多个palybook</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@ansible</span> <span class="string">~</span>]<span class="comment"># cat site.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webs</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">include_tasks:</span> <span class="string">install_nginx.yml</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">==</span> <span class="string">&quot;web01&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">include_tasks:</span> <span class="string">install_nfs.yml</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_hostname</span> <span class="string">==</span> <span class="string">&quot;web02&quot;</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~</span>]<span class="comment"># cat install_nginx.yml </span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Nginx</span> <span class="string">Server</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~</span>]<span class="comment"># cat install_nfs.yml </span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">nfs</span> <span class="string">Server</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-utils</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br></pre></td></tr></table></figure></blockquote><div class='spoiler collapsed'>    <div class='spoiler-title'>        Playbook任务标签    </div>    <div class='spoiler-content'>        <p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240104203741222.png" alt="image-20240104203741222"></p>    </div></div><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;Ansible流程控制&lt;/center&gt;&lt;/h1&gt;
&lt;p&gt;  不管是shell还是各大编程语言中，流程控制、条件判断、循环这些都是必不可少的，在我们使用Ansible的过程中，条件判断的使用频率同样极其的高，是我们必须掌握的技能。&lt;/p&gt;
&lt;h2 id=&quot;一、when判断&quot;&gt;一、when判断&lt;/h2&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;hosts:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;webs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;tasks:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt;  &lt;span class=&quot;string&quot;&gt;when&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;ceshi&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attr&quot;&gt;yum:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;htop&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;tree&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;state:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;present&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attr&quot;&gt;when:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;ansible_hostname&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;web01&amp;quot;&lt;/span&gt;   &lt;span class=&quot;comment&quot;&gt;### 当主机名为web01时执行本条任务&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240104191250989.png&quot; alt=&quot;image-20240104191250989&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="服务架构" scheme="https://smallflames.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>Ansible变量定义</title>
    <link href="https://smallflames.github.io/2024/01/03/Ansible%E5%8F%98%E9%87%8F%E5%AE%9A%E4%B9%89/"/>
    <id>https://smallflames.github.io/2024/01/03/Ansible%E5%8F%98%E9%87%8F%E5%AE%9A%E4%B9%89/</id>
    <published>2024-01-03T10:29:22.000Z</published>
    <updated>2024-01-04T10:38:06.483Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>Ansible变量</center></h1><h2 id="一、在命令行中定义变量">一、在命令行中定义变量</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment">#ansible webs -a &#x27;echo &#123;&#123; a &#125;&#125;南汐&#123;&#123; b &#125;&#125;&#x27; -e &#x27;a=欢迎来到&#x27; -e &#x27;b=的个人世界&#x27;</span></span><br><span class="line">192.168.10.8 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">欢迎来到南汐的个人世界</span><br><span class="line">192.168.10.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">欢迎来到南汐的个人世界</span><br></pre></td></tr></table></figure><h2 id="二、在play中定义变量">二、在play中定义变量</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.7</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">packages:</span> <span class="string">htop</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> &#123;&#123; <span class="string">packages</span> &#125;&#125;</span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; packages &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240103190009022.png" alt="image-20240103190009022"></p><span id="more"></span><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240103190951093.png" alt="image-20240103190951093"></p><div class='spoiler collapsed'>    <div class='spoiler-title'>        将单独变量写入一个yaml格式文件在play中引用    </div>    <div class='spoiler-content'>        <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]<span class="comment"># cat vars.yml </span></span><br><span class="line">pk1: lrzsz</span><br><span class="line">pk2: wget</span><br><span class="line">pk3: tree</span><br><span class="line">[root@ansible ~]<span class="comment"># cat vars1.yml </span></span><br><span class="line">pk4: cowsay</span><br><span class="line"></span><br><span class="line">[root@ansible ~]<span class="comment"># cat ceshi.yml</span></span><br><span class="line">- hosts: webs</span><br><span class="line">  vars_files: </span><br><span class="line">    - vars.yml</span><br><span class="line">    - vars1.yml</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install packsges</span><br><span class="line">      yum:</span><br><span class="line">        name: </span><br><span class="line">          - <span class="string">&quot;&#123;&#123; pk1 &#125;&#125;&quot;</span></span><br><span class="line">          - <span class="string">&quot;&#123;&#123; pk4 &#125;&#125;&quot;</span></span><br><span class="line">        state: present</span><br></pre></td></tr></table></figure>    </div></div><h2 id="三、在主机资产中定义变量">三、在主机资产中定义变量</h2><h3 id="1、主机变量">1、主机变量</h3><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240103191838871.png" alt="image-20240103191838871"></p><h3 id="2、主机组变量">2、主机组变量</h3><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240103192548782.png" alt="image-20240103192548782"></p><div class="success"><p><strong><center>变量定义的优先级：命令行变量&gt;play中的变量&gt;主机变量&gt;主机组变量</center></strong></p></div><h2 id="四、官方推荐方式定义变量">四、官方推荐方式定义变量</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">1.定义变量 给组定义变量</span><br><span class="line">[root@ansible ~]<span class="comment"># mkdir group_vars</span></span><br><span class="line">[root@ansible ~]<span class="comment"># cat group_vars/webs.yml</span></span><br><span class="line">pk1: wget</span><br><span class="line">pk2: tree</span><br><span class="line">2.调用变量</span><br><span class="line">[root@ansible ~]<span class="comment"># cat ceshi.yml</span></span><br><span class="line">- hosts: webs</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install packsges</span><br><span class="line">      yum:</span><br><span class="line">        name: </span><br><span class="line">          - <span class="string">&quot;&#123;&#123; pk1 &#125;&#125;&quot;</span></span><br><span class="line">          - <span class="string">&quot;&#123;&#123; pk2 &#125;&#125;&quot;</span></span><br><span class="line">        state: present</span><br><span class="line"></span><br><span class="line">单台定义变量：</span><br><span class="line">1.定义变量</span><br><span class="line">[root@ansible ~]<span class="comment"># mkdir host_vars</span></span><br><span class="line">[root@ansible ~]<span class="comment"># cat host_vars/192.168.10.8.yml</span></span><br><span class="line">pk1: wget</span><br><span class="line">pk2: tree </span><br><span class="line"></span><br><span class="line">2.调用变量</span><br><span class="line">[root@ansible ~]<span class="comment"># cat ceshi.yml </span></span><br><span class="line">- hosts: webs</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install packsges</span><br><span class="line">      yum:</span><br><span class="line">        name: </span><br><span class="line">          - <span class="string">&quot;&#123;&#123; pk1 &#125;&#125;&quot;</span></span><br><span class="line">          - <span class="string">&quot;&#123;&#123; pk2 &#125;&#125;&quot;</span></span><br><span class="line">        state: present</span><br></pre></td></tr></table></figure><h2 id="五、使用变量创建文件">五、使用变量创建文件</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">案例.使用变量创建一个文件</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~</span>]<span class="comment"># cat ceshi.yml </span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.7</span></span><br><span class="line">  <span class="attr">vars:</span> </span><br><span class="line">     <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.7</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">web01</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">packsges</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/root/&#123;&#123;</span> <span class="string">host</span> <span class="string">&#125;&#125;_&#123;&#123;</span> <span class="string">ip</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line"><span class="string">案例.使用ansible的内置变量</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~</span>]<span class="comment"># cat ceshi.yml </span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.7</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">packsges</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/root/&#123;&#123;</span> <span class="string">ansible_hostname</span> <span class="string">&#125;&#125;_&#123;&#123;</span> <span class="string">ansible_default_ipv4.address</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br></pre></td></tr></table></figure><h2 id="六、变量注册">六、变量注册</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 当我们使用ansible时，想要显示命令返回的结果，就可以使用变量注册的方式</span></span><br><span class="line">- hosts: 192.168.10.7</span><br><span class="line">  tasks:</span><br><span class="line">    - name: ceshi vars register</span><br><span class="line">      shell: <span class="built_in">ls</span> -l /</span><br><span class="line">      register: ll                   <span class="comment">#   定义变量注册 名称自定义  </span></span><br><span class="line">      </span><br><span class="line">    - name: <span class="built_in">print</span> list</span><br><span class="line">      debug:</span><br><span class="line">        msg: <span class="string">&quot;&#123;&#123; ll.stdout_lines &#125;&#125;&quot;</span> <span class="comment">#   调用变量，并指定输出特定字段</span></span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240104183013626.png" alt="image-20240104183013626"></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;Ansible变量&lt;/center&gt;&lt;/h1&gt;
&lt;h2 id=&quot;一、在命令行中定义变量&quot;&gt;一、在命令行中定义变量&lt;/h2&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@ansible ~]&lt;span class=&quot;comment&quot;&gt;#ansible webs -a &amp;#x27;echo &amp;#123;&amp;#123; a &amp;#125;&amp;#125;南汐&amp;#123;&amp;#123; b &amp;#125;&amp;#125;&amp;#x27; -e &amp;#x27;a=欢迎来到&amp;#x27; -e &amp;#x27;b=的个人世界&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;192.168.10.8 | CHANGED | rc=0 &amp;gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;欢迎来到南汐的个人世界&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;192.168.10.7 | CHANGED | rc=0 &amp;gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;欢迎来到南汐的个人世界&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;二、在play中定义变量&quot;&gt;二、在play中定义变量&lt;/h2&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;hosts:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;192.168&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.10&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.7&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;vars:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;packages:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;htop&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;tasks:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;install&lt;/span&gt; &amp;#123;&amp;#123; &lt;span class=&quot;string&quot;&gt;packages&lt;/span&gt; &amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attr&quot;&gt;yum:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;&lt;span class=&quot;template-variable&quot;&gt;&amp;#123;&amp;#123; packages &amp;#125;&amp;#125;&lt;/span&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attr&quot;&gt;state:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;present&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240103190009022.png&quot; alt=&quot;image-20240103190009022&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="服务架构" scheme="https://smallflames.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>Ansible-playbook简述</title>
    <link href="https://smallflames.github.io/2024/01/03/Ansible-playbook%E7%AE%80%E8%BF%B0/"/>
    <id>https://smallflames.github.io/2024/01/03/Ansible-playbook%E7%AE%80%E8%BF%B0/</id>
    <published>2024-01-03T09:45:06.000Z</published>
    <updated>2024-01-03T11:50:51.475Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>Ansible-playbook简述</center></h1><p>  如果我们ad-hoc看成是单条的shell，那么playbook就是类似shell脚本的存在，虽然它比不上shell脚本的便捷和可用性，但它在自动化运维中绝对是把利器，对于批量化主机管理playbook是我们必须掌握并精通的，因为它可以充分发挥ansible的强大！！！</p><p>  Ansible-playbook的书写遵循yml语言格式，并以ansible的模块为基础，从而实现对复杂指令的编排应用，如以下的playbook书写，实现了对rsync服务的部署，同样的它可以应用到更多的主机或者集群……</p><span id="more"></span><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主机资产如下</span></span><br><span class="line">[webs]</span><br><span class="line">192.168.10.7</span><br><span class="line">192.168.10.8</span><br><span class="line">[backups]</span><br><span class="line">192.168.10.41</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">all</span> <span class="string">software</span> <span class="string">prepare</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">rsync</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">rsync</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">www</span> <span class="string">group</span></span><br><span class="line">      <span class="attr">group:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">gid:</span> <span class="number">666</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">www</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span> </span><br><span class="line">        <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">uid:</span> <span class="number">666</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">shell:</span> <span class="string">/sbin/nologin</span></span><br><span class="line">        <span class="attr">create_home:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">backups</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">configure</span> <span class="string">backup</span> <span class="string">rsync-server</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mkdir</span> <span class="string">/backup</span></span><br><span class="line">      <span class="attr">file:</span> </span><br><span class="line">        <span class="attr">path:</span> <span class="string">/backup</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">configure</span> <span class="string">rsync</span></span><br><span class="line">      <span class="attr">copy:</span> </span><br><span class="line">        <span class="attr">src:</span> <span class="string">rsyncd.conf</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">passwd</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">copy:</span> </span><br><span class="line">        <span class="attr">content:</span> <span class="string">rsync_backup:nanxi</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/rsync.passwd</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0600</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webs</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">configure</span> <span class="string">webs</span> <span class="string">rssync-client</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">rsync.pass</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">content:</span> <span class="string">nanxi</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/rsync.pass</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0600</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">start</span> <span class="string">rsync</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">rsyncd</span></span><br><span class="line">      <span class="attr">systemd:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">rsyncd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;Ansible-playbook简述&lt;/center&gt;&lt;/h1&gt;
&lt;p&gt;  如果我们ad-hoc看成是单条的shell，那么playbook就是类似shell脚本的存在，虽然它比不上shell脚本的便捷和可用性，但它在自动化运维中绝对是把利器，对于批量化主机管理playbook是我们必须掌握并精通的，因为它可以充分发挥ansible的强大！！！&lt;/p&gt;
&lt;p&gt;  Ansible-playbook的书写遵循yml语言格式，并以ansible的模块为基础，从而实现对复杂指令的编排应用，如以下的playbook书写，实现了对rsync服务的部署，同样的它可以应用到更多的主机或者集群……&lt;/p&gt;</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="服务架构" scheme="https://smallflames.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>自动化运维工具Ansible</title>
    <link href="https://smallflames.github.io/2024/01/02/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%B7%A5%E5%85%B7Ansible/"/>
    <id>https://smallflames.github.io/2024/01/02/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%B7%A5%E5%85%B7Ansible/</id>
    <published>2024-01-02T12:18:48.000Z</published>
    <updated>2024-01-03T10:15:49.838Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>自动化运维工具Ansible简述</center></h1><p>  <code>ad-hoc</code>临时命令，执行完即结束，并不会保存，常用于单条命令的执行，如果涉及到复杂的管理操作，且可能需要持久化使用时，我们会使用<code>playbook</code>。<code>PlayBook</code> 功能比 <code>ad-hoc</code> 更全，是对 <code>ad-hoc</code> 的一种编排，能很好的控制先后执行顺序，以及依赖关系，而且语法展现更加的直观。但是本节我们仅展示基础的Ansible语法和基本使用模块。</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240103180947088.png" alt="image-20240103180947088"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240102213135360.png" alt="image-20240102213135360"></p><span id="more"></span><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum      <span class="comment">#  用来安装服务；</span></span><br><span class="line">         eg：ansible web -i hosts -m yum -a <span class="string">&quot;name=httpd state=present&quot;</span></span><br><span class="line">         state ：present、absent、late</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">copy     <span class="comment">#   推送文件模块</span></span><br><span class="line">         eg：ansible web -i hosts -m copy -a <span class="string">&quot;src=/etc/passwd dest=/tmp/nanxi.txt&quot;</span></span><br><span class="line">        （backup=<span class="built_in">yes</span> 推送前校验MD5，若不同则备份）</span><br><span class="line">        </span><br><span class="line">         eg：ansible web -m copy -a <span class="string">&quot;content=&#x27;nanxi&#x27; dest=/tmp/nanxi.txt&quot;</span></span><br><span class="line">         <span class="comment">#直接批量在被管理端文件中添加内容、其他属性还有owner、group、mode</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file     <span class="comment">#   文件管理模块</span></span><br><span class="line">         eg：ansible web -m file -a <span class="string">&quot;path=/tmp/nanxi state=touch&quot;</span></span><br><span class="line">         state ：<span class="built_in">touch</span>、directory、<span class="built_in">link</span>、hard、absent、owner、group、mode</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">get_url  <span class="comment">#   网络资源下载模块</span></span><br><span class="line">         eg：ansible web -m get_url -a <span class="string">&#x27;url=https://mirrors.aliyun.com……  dest=/tmp&#x27;</span> </span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemd  <span class="comment">#   服务管理模块</span></span><br><span class="line">         eg：ansible web -m systemd -a <span class="string">&quot;name=nginx state=started enabled=yes&quot;</span></span><br><span class="line">         state ：started、stopped、restarted、reloaded</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cron     <span class="comment">#   定时任务模块</span></span><br><span class="line">         eg：ansible web -m cron -a <span class="string">&#x27;name=ceshi minute=*/5 job=&quot;/bin/sh /server/scripts/test.sh&quot;&#x27;</span></span><br><span class="line">         eg：ansible web -m cron -a <span class="string">&#x27;name=ceshi state=absent&#x27;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mount    <span class="comment">#   磁盘挂载模块</span></span><br><span class="line">         eg：ansible web -m mount -a <span class="string">&quot;src=172.16.1.31:/data path=/data fstype=nfs state=present&quot;</span></span><br><span class="line">         state：present、mounted、unmounted、absent</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user     <span class="comment">#   用户管理模块</span></span><br><span class="line">         eg：ansible web -m user -a <span class="string">&quot;name=nanxi uid=888 group=888 shell=/sbin/nologin create_home=false&quot;</span></span><br><span class="line"></span><br><span class="line">group    <span class="comment">#   eg：ansible web -m group -a &quot;name=oldboy gid=888&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum_repository <span class="comment">#  修改yum仓库，用官方仓库安装软件时使用</span></span><br><span class="line">         eg：ansible web -m yum_repository -a <span class="string">&#x27;name=nginx description=nginx_official_repo baseurl= https://download...&#x27;</span></span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;自动化运维工具Ansible简述&lt;/center&gt;&lt;/h1&gt;
&lt;p&gt;  &lt;code&gt;ad-hoc&lt;/code&gt;临时命令，执行完即结束，并不会保存，常用于单条命令的执行，如果涉及到复杂的管理操作，且可能需要持久化使用时，我们会使用&lt;code&gt;playbook&lt;/code&gt;。&lt;code&gt;PlayBook&lt;/code&gt; 功能比 &lt;code&gt;ad-hoc&lt;/code&gt; 更全，是对 &lt;code&gt;ad-hoc&lt;/code&gt; 的一种编排，能很好的控制先后执行顺序，以及依赖关系，而且语法展现更加的直观。但是本节我们仅展示基础的Ansible语法和基本使用模块。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240103180947088.png&quot; alt=&quot;image-20240103180947088&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/XZ6606/image-bed/raw/master/img/image-20240102213135360.png&quot; alt=&quot;image-20240102213135360&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="服务架构" scheme="https://smallflames.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>Tomcat入门篇</title>
    <link href="https://smallflames.github.io/2023/12/25/Tomcat%E5%85%A5%E9%97%A8%E7%AF%87/"/>
    <id>https://smallflames.github.io/2023/12/25/Tomcat%E5%85%A5%E9%97%A8%E7%AF%87/</id>
    <published>2023-12-25T12:37:02.000Z</published>
    <updated>2023-12-25T15:00:52.233Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>Tomcat入门篇</center></h1><h2 id="一、Tomcat环境准备和安装">一、Tomcat环境准备和安装</h2><p>  <mark>Tomcat是基于JAVA开发的WEB服务，主要用来解析JAVA代码</mark>。Nginx仅支持静态资源解析，而Tomcat支持解析Java开发的WEB应用，还支持解析静态资源（效率不高），<mark>Nginx适合做前端负载均衡，Tomcat适合做后端应用服务处理</mark>，通常情况企业会使用Nginx+Tomcat结合，Nginx处理静态资源，Tomcat处理动态资源。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### java环境安装</span></span><br><span class="line">yum -y install java  <span class="comment">### 或者我们可以直接去官网下载jdk工具包，通常选择1.8版本，百年老字号哈哈哈哈哈~ 南汐选择的是安装jdk</span></span><br><span class="line"><span class="comment">#这是官网的版本选择地址：https://docs.oracle.com/javase/8/docs/technotes/guides/install/linux_jdk.html</span></span><br><span class="line">[root@web1 ~]<span class="comment">#rpm -qa |grep jdk</span></span><br><span class="line">jdk1.8-1.8.0_341-fcs.x86_64</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 安装tomcat软件</span></span><br><span class="line"><span class="comment"># tomcat官网地址：https://tomcat.apache.org/  认准这只小公猫哦~</span></span><br><span class="line">[root@web1 ~]<span class="comment">#mkdir /soft</span></span><br><span class="line"><span class="comment"># 在新建的目录里下载tomcat服务，解压后可直接使用，无需安装，开箱即用</span></span><br><span class="line">[root@web1 /soft]<span class="comment">#wget https://dlcdn.apache.org/tomcat/lltomcat-9/v9.0.84/bin/apache-tomcat-9.0.84.tar.gz</span></span><br><span class="line">...</span><br><span class="line"><span class="comment"># 为tomcat创建软件链接，目的在于保留版本信息的同时方便使用，其次方便以后故障时的版本回退</span></span><br><span class="line">[root@web1 /soft]<span class="comment">#ln -s apache-tomcat-9.0.84/ tomcat</span></span><br><span class="line">[root@web1 /soft]<span class="comment">#ll</span></span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x 9 root root 220 Dec 25 16:13 apache-tomcat-9.0.84</span><br><span class="line">lrwxrwxrwx 1 root root  27 Dec 25 16:15 tomcat -&gt; /soft/apache-tomcat-9.0.84/</span><br></pre></td></tr></table></figure><span id="more"></span><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### tomcat使用</span></span><br><span class="line">[root@web1 ~]<span class="comment">#/soft/tomcat/bin/startup.sh    # 启动tomcat服务后默认8080端口</span></span><br><span class="line">[root@web1 ~]<span class="comment">#/soft/tomcat/bin/shutdown.sh # 停止tomcat     默认8005端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 将tomcat服务交给systemctl管理</span></span><br><span class="line"><span class="built_in">cat</span> &gt;/usr/lib/systemd/system/tomcat.service&lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Apache Tomcat Server</span><br><span class="line">After=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=/soft/tomcat/bin/startup.sh</span><br><span class="line">ExecStop=/soft/tomcat/bin/shutdown.sh</span><br><span class="line">ExecRestart=/soft/tomcat/bin/shutdown.sh  &amp;&amp; sleep2  &amp;&amp; /soft/tomcat/bin/startup.sh</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># 以上我们用到的是输出重定向，EOF为语句块标签，标识把下面语句块内容交给前面的命令执行，这个方式在脚本中，经常使用，尤其常在远程服务器运行本地脚本时使用</span></span><br><span class="line"></span><br><span class="line">[root@web1 ~]<span class="comment">#systemctl daemon-reload</span></span><br><span class="line">[root@web1 ~]<span class="comment">#systemctl enable  tomcat</span></span><br></pre></td></tr></table></figure><h2 id="二、tomcat配置文件简述">二、tomcat配置文件简述</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tomcat软件目录结构：</span><br><span class="line"></span><br><span class="line">bin      ---主要包含启动和关闭tomcat的脚本（启停java脚本依赖jar包文件）</span><br><span class="line">conf  ---tomcat配置文件的目录(站点配置：server.xml)</span><br><span class="line">lib      ---tomcat运行时需要加载的jar包</span><br><span class="line">logs  ---tomcat日志存放位置</span><br><span class="line">temp  ---tomcat临时存放文件路径</span><br><span class="line">webapps  ---tomcat默认站点目录</span><br><span class="line">work  ---tomcat运行时产生的缓存文件，尽量不要轻易清楚，可能会丢失配置</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231225213941114.png" alt="image-20231225213941114"></p><p>  用户发出一个请求，如<a href="http://nanxi.com:8080/index.jsp">http://nanxi.com:8080/index.jsp</a> Connector发现是http/1.1协议，而且还是8080端口，于是就把请求接收后交给符合条件的Engine，Engine通过请求中的主机名nanxi.com查找满足条件的虚拟主机(Host)，找到后就去此虚拟主机指定的appBase（代码存放的目录）最后将解析产生的结果返回给用户。</p><div class='spoiler collapsed'>    <div class='spoiler-title'>        开启tomcat可视化管理页面    </div>    <div class='spoiler-content'>        <p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231225214742363.png" alt="image-20231225214742363"></p><p>1️⃣   <code>vim /soft/tomcat/conf/tomcat-users.xml</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&lt;role rolename=<span class="string">&quot;manager-gui&quot;</span>/&gt;</span><br><span class="line">&lt;role rolename=<span class="string">&quot;admin-gui&quot;</span>/&gt;</span><br><span class="line">&lt;user username=<span class="string">&quot;nanxi&quot;</span> password=<span class="string">&quot;123&quot;</span> roles=<span class="string">&quot;manager-gui,admin-gui&quot;</span>/&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/tomcat-users&gt;</span><br></pre></td></tr></table></figure><p>2️⃣   <code>vim /soft/tomcat/webapps/host-manager/META-INF/context.xml</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">### 修改value值允许所有IP访问</span></span><br><span class="line">&lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span></span><br><span class="line">         allow=<span class="string">&quot;\d+\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1&quot;</span> /&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>3️⃣   <code>vim /soft/tomcat/webapps/manager/META-INF/context.xml</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">### 修改value值允许所有IP访问</span></span><br><span class="line">&lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span></span><br><span class="line">       allow=<span class="string">&quot;\d+\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1&quot;</span> /&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>4️⃣   <code>systemctl restart tomcat</code>  重启tomcat服务；</p>    </div></div><h2 id="三、使用Tomcat部署zrlog产品">三、使用Tomcat部署zrlog产品</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 定义虚拟主机</span></span><br><span class="line">&lt;Host name=<span class="string">&quot;zrlog.nanxi.com&quot;</span>  appBase=<span class="string">&quot;/code/zrlog&quot;</span></span><br><span class="line">    unpackWARs=<span class="string">&quot;true&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">&lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> directory=<span class="string">&quot;logs&quot;</span></span><br><span class="line">       prefix=<span class="string">&quot;zrlog.nanxi.com_access&quot;</span> suffix=<span class="string">&quot;.log&quot;</span></span><br><span class="line">       pattern=<span class="string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;</span><br><span class="line">&lt;/Host&gt;</span><br><span class="line"><span class="comment">### 创建资源目录</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;Tomcat入门篇&lt;/center&gt;&lt;/h1&gt;
&lt;h2 id=&quot;一、Tomcat环境准备和安装&quot;&gt;一、Tomcat环境准备和安装&lt;/h2&gt;
&lt;p&gt;  &lt;mark&gt;Tomcat是基于JAVA开发的WEB服务，主要用来解析JAVA代码&lt;/mark&gt;。Nginx仅支持静态资源解析，而Tomcat支持解析Java开发的WEB应用，还支持解析静态资源（效率不高），&lt;mark&gt;Nginx适合做前端负载均衡，Tomcat适合做后端应用服务处理&lt;/mark&gt;，通常情况企业会使用Nginx+Tomcat结合，Nginx处理静态资源，Tomcat处理动态资源。&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;### java环境安装&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum -y install java  &lt;span class=&quot;comment&quot;&gt;### 或者我们可以直接去官网下载jdk工具包，通常选择1.8版本，百年老字号哈哈哈哈哈~ 南汐选择的是安装jdk&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#这是官网的版本选择地址：https://docs.oracle.com/javase/8/docs/technotes/guides/install/linux_jdk.html&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[root@web1 ~]&lt;span class=&quot;comment&quot;&gt;#rpm -qa |grep jdk&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;jdk1.8-1.8.0_341-fcs.x86_64&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;### 安装tomcat软件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# tomcat官网地址：https://tomcat.apache.org/  认准这只小公猫哦~&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[root@web1 ~]&lt;span class=&quot;comment&quot;&gt;#mkdir /soft&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 在新建的目录里下载tomcat服务，解压后可直接使用，无需安装，开箱即用&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[root@web1 /soft]&lt;span class=&quot;comment&quot;&gt;#wget https://dlcdn.apache.org/tomcat/lltomcat-9/v9.0.84/bin/apache-tomcat-9.0.84.tar.gz&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 为tomcat创建软件链接，目的在于保留版本信息的同时方便使用，其次方便以后故障时的版本回退&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[root@web1 /soft]&lt;span class=&quot;comment&quot;&gt;#ln -s apache-tomcat-9.0.84/ tomcat&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[root@web1 /soft]&lt;span class=&quot;comment&quot;&gt;#ll&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;total 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;drwxr-xr-x 9 root root 220 Dec 25 16:13 apache-tomcat-9.0.84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;lrwxrwxrwx 1 root root  27 Dec 25 16:15 tomcat -&amp;gt; /soft/apache-tomcat-9.0.84/&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="服务架构" scheme="https://smallflames.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>Nginx性能优化</title>
    <link href="https://smallflames.github.io/2023/12/22/Nginx%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    <id>https://smallflames.github.io/2023/12/22/Nginx%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/</id>
    <published>2023-12-22T07:32:10.000Z</published>
    <updated>2023-12-22T10:47:15.216Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>Nginx性能优化</center></h1><h2 id="一、性能优化概述">一、性能优化概述</h2><p>  做事有做事的原则，解决问题有解决问题的方法，那我们在做性能优化工作之前也同样要有自己的逻辑，我们为什么要做优化，我们需要重点考虑哪些方面，和了解哪些方面呢？在南汐看来，一切优化工作的目的就是基于业务稳定安全的前提下尽可能的提高用户的访问体验。</p><p>  1、首先我们需要了解当前系统的结构和瓶颈，当我们的脑袋里存在一个明确的业务框架逻辑时，那么我们对于就会有一个明确的方向。比如了解我们公司当前使用的是什么，运行的是什么业务，都有哪些服务，了解每个服务最大可支撑多少并发，能支持多少qps（每秒查询率）的访问请求，这组系统的最高瓶颈在哪里？<font color="gray"><em>（我们如何评定我们系统的瓶颈呢，例如使用top查看系统的CPU负载、内存使用率、总得运行进程等，也可以通过日志去分析请求的情况，也可以通过我们前面介绍到的stub_statius模块查看当前的连接情况，对线上的业务进行压力测试【低峰期】，去了解当前这套系统能承担多少的请求和并发，做好响应的评估。这个是我们做性能优化最先考虑的地方。）</em></font></p><p>  2、了解业务模式。性能优化是为业务服务的，本质上就是提高业务能力。我们需要了解每个业务接口的类型，比如：电商网站中的抢购模式，这种情况下面，平时没什么流量，但到了抢购时间流量会突增。我们还需要了解系统层次化的结构，比如：我们使用nginx做的是代理、还是动静分离、还是后端直接服务用户，我们要对每一层做好相应的梳理，以便更好的服务业务。</p><p>  3、性能与安全。通常会有这样一个情况，我们往往注重了性能，但是忽略了安全，往往过于注重安全，对性能又会产生影响。比如：我们在设计防火墙功能时，检测过于严密，这样就会给性能带来影响。那么如果对于性能完全追求，却不顾服务的安全，也会造成很大的隐患。我们需要评估好两者的关系，把握好两者的孰重孰轻。以及整体的相关性，权衡好对应的点。</p><h2 id="二、压力测试工具">二、压力测试工具</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@web1 ~]<span class="comment">#yum -y install httpd-tools</span></span><br><span class="line">[root@web1 ~]<span class="comment">#ab -k -c100 -n1000 http://nanxi.com/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### -n 要执行的请求数  -c 请求的并发数  -k 是否开启长连接</span></span><br></pre></td></tr></table></figure><p>  我们可以先以自己的静态网页为例（现在很多的网站基本都会设置屏蔽外界压测），来做一个小测试：</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231222163408848.png" alt="image-20231222163408848"></p><span id="more"></span><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">[root@web1 ~]<span class="comment">#ab -k -c100 -n1000 http://nanxi.com/</span></span><br><span class="line">This is ApacheBench, Version 2.3 &lt;<span class="variable">$Revision</span>: 1430300 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking nanxi.com (be patient)</span><br><span class="line">Completed 100 requests</span><br><span class="line">Completed 200 requests</span><br><span class="line">Completed 300 requests</span><br><span class="line">Completed 400 requests</span><br><span class="line">Completed 500 requests</span><br><span class="line">Completed 600 requests</span><br><span class="line">Completed 700 requests</span><br><span class="line">Completed 800 requests</span><br><span class="line">Completed 900 requests</span><br><span class="line">Completed 1000 requests</span><br><span class="line">Finished 1000 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        Apache/2.4.6   <span class="comment">#测试服务器的名字</span></span><br><span class="line">Server Hostname:        nanxi.com      <span class="comment">#请求的URL主机名</span></span><br><span class="line">Server Port:            80             <span class="comment">#请求端口</span></span><br><span class="line"></span><br><span class="line">Document Path:          /              <span class="comment">#请求路径</span></span><br><span class="line">Document Length:        9344 bytes     <span class="comment">#HTTP响应数据的正文长度</span></span><br><span class="line"></span><br><span class="line">Concurrency Level:      100            <span class="comment">#并发用户数，我们设置的参数</span></span><br><span class="line">Time taken <span class="keyword">for</span> tests:   26.822 seconds <span class="comment">#所有这些请求被处理完成所花费的总时间 单位秒</span></span><br><span class="line">Complete requests:      1000           <span class="comment">#总请求数量，也是我们设置的参数之一</span></span><br><span class="line">Failed requests:        51             <span class="comment">#表示失败的请求数量</span></span><br><span class="line">   (Connect: 0, Receive: 0, Length: 51, Exceptions: 0)</span><br><span class="line">Write errors:           0</span><br><span class="line">Keep-Alive requests:    952</span><br><span class="line">Total transferred:      9392739 bytes  <span class="comment">#所有请求的响应数据长度总和，包括每个HTTP响应数据的头信息和正文数据的长度</span></span><br><span class="line">HTML transferred:       9089389 bytes  <span class="comment">#所有请求的响应数据中正文数据的总和，也就是减去了Total transferred中HTTP响应数据中的头信息的长度</span></span><br><span class="line">Requests per second:    37.28 [<span class="comment">#/sec] (mean)  #吞吐量  总请求数/处理完成这些请求数所花费的时间</span></span><br><span class="line">Time per request:       2682.194 [ms] (mean)  <span class="comment">#用户平均请求等待时间，处理完成所有请求数所花费的时间/（总请求数/并发用户数）     </span></span><br><span class="line">Time per request:       26.822 [ms] (mean, across all concurrent requests) <span class="comment">#服务器平均请求等待时间</span></span><br><span class="line">Transfer rate:          341.98 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0   28  86.2      0     678</span><br><span class="line">Processing:     0 2529 2167.9   1760   13955</span><br><span class="line">Waiting:        0  887 1525.8    408    7873</span><br><span class="line">Total:          0 2557 2198.7   1770   14148</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%   1770</span><br><span class="line">  66%   3120</span><br><span class="line">  75%   3949</span><br><span class="line">  80%   4334</span><br><span class="line">  90%   5290</span><br><span class="line">  95%   7506</span><br><span class="line">  98%   8587</span><br><span class="line">  99%   8860</span><br><span class="line"> 100%  14148 (longest request)</span><br></pre></td></tr></table></figure><h2 id="三、性能优化">三、性能优化</h2><h3 id="1、系统性能优化">1、系统性能优化</h3><p>  文件句柄，Linux一切皆文件，文件句柄可以理解为就是一个索引，文件句柄会随着我们进程的调用频繁增加，系统默认文件句柄是有限制的，不能让一个进程无限的调用，所以我们需要限制每个进程和每个服务使用多大的文件句柄</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]<span class="comment"># vim /etc/security/limits.conf</span></span><br><span class="line"></span><br><span class="line">1、系统全局性修改。</span><br><span class="line"><span class="comment"># * 代表所有用户</span></span><br><span class="line">* soft nofile 25535</span><br><span class="line">* hard nofile 25535</span><br><span class="line"></span><br><span class="line">2.用户局部性修改</span><br><span class="line"><span class="comment">#针对root用户，soft仅提醒，hard限制，nofile打开最大文件数</span></span><br><span class="line">root soft nofile 65535</span><br><span class="line">root hard nofile 65535</span><br><span class="line"></span><br><span class="line">3.进程局部性修改</span><br><span class="line"><span class="comment">#针对nginx进程，nginx自带配置</span></span><br><span class="line">worker_rlimit_nofile 30000</span><br><span class="line"></span><br><span class="line">4.调整内核参数：让time_wait状态重用(端口重用)[flag]</span><br><span class="line">[root@web01 ROOT]<span class="comment"># vim /etc/sysctl.conf</span></span><br><span class="line">net.ipv4.tcp_tw_reuse = 1     <span class="comment"># 开启端口复用</span></span><br><span class="line">net.ipv4.tcp_timestamps = 0   <span class="comment"># 禁用时间戳</span></span><br><span class="line">[root@web01 ROOT]<span class="comment"># sysctl -p    #可以查看我们添加的内核参数</span></span><br><span class="line">[root@web01 ROOT]<span class="comment"># sysctl -a    #可以查看所有内核参数</span></span><br></pre></td></tr></table></figure><p>  在高并发短连接的TCP服务器上，当服务器处理完请求后立刻主动正常关闭连接。这个场景下会出现大量socket处于TIME_WAIT状态。如果客户端的并发量持续很高，此时部分客户端就会显示连接不上。</p><p>  为什么我们要关注这个高并发短连接呢？<strong>高并发可以让服务器在短时间范围内同时占用大量端口</strong>，而端口有个0~65535的范围，并不是很多，除去系统和其他服务要用的，剩下的就更少了。在这个场景中，短连接表示<strong>业务处理+传输数据的时间远远小于 TIMEWAIT超时的时间</strong>的连接。比如取一个web页面,1秒钟的http短连接处理完业务，在关闭连接之后，这个业务用过的端口会停留在TIMEWAIT状态几分钟，而这几分钟，其他HTTP请求来临的时候是无法占用此端口的。。单用这个业务计算服务器的利用率会发现，服务器干正经事的时间和端口（资源）被挂着无法被使用的时间的比例是 1：几百，服务器资源严重浪费。（<font color="red">在实际业务场景中，一般长连接对应的业务的并发量并不会很高。</font>）</p><h3 id="2、代理服务优化">2、代理服务优化</h3><p>  通常nginx作为代理服务，负责转发用户的请求，那么在转发的过程中建议开启HTTP长连接，用于减少握手次数，降低服务器损耗。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    server 127.0.0.1:8080;</span><br><span class="line">    keepalive 16;   <span class="comment">#长连接</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    location /http/ &#123;</span><br><span class="line">        proxy_pass http://backend;</span><br><span class="line">        proxy_http_version 1.1;         <span class="comment">#对于http协议应该指定为1.1</span></span><br><span class="line">        proxy_set_header Connection <span class="string">&quot;&quot;</span>; <span class="comment">#清除“connection”头字段</span></span><br><span class="line">        proxy_next_upstream error <span class="built_in">timeout</span> http_500 http_502 http_503 http_504;  <span class="comment">#平滑过渡</span></span><br><span class="line">        proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwared-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_connect_timeout 30s;      <span class="comment"># 代理连接web超时时间</span></span><br><span class="line">        proxy_read_timeout 60s;         <span class="comment"># 代理等待web响应超时时间</span></span><br><span class="line">        proxy_send_timeout 60s;         <span class="comment"># web回传数据至代理超时时间</span></span><br><span class="line">        proxy_buffering on;             <span class="comment"># 开启代理缓冲区,web回传数据至缓冲区,代理边收边传返回给客户端</span></span><br><span class="line">        proxy_buffer_size 32k;          <span class="comment"># 代理接收web响应的头信息的缓冲区大小</span></span><br><span class="line">        proxy_buffers 4 128k;           <span class="comment"># 缓冲代理接收单个长连接内包含的web响应的数量和大小</span></span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  对于fastcgi服务器，需要设置fastcgi_keep_conn以便保持长连接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">upstream fastcgi_backend &#123;</span><br><span class="line">    server 127.0.0.1:9000;</span><br><span class="line">    keepalive 8;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    location /fastcgi/ &#123;</span><br><span class="line">        fastcgi_pass fastcgi_backend;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        fastcgi_keep_conn on;   </span><br><span class="line">        fastcgi_connect_timeout 60s;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  scgi和uwsgi协议没有保持连接的概念，但无论是proxy、fastcgi、uwsgi协议都有cache缓存的功能，开启后可加速网站访问的效率（取决硬件）。</p><h3 id="3、静态资源优化">3、静态资源优化</h3><p>  静态资源指的是非WEB服务器端运行处理而生成的文件：</p><table><thead><tr><th>静态资源类型</th><th>种类</th></tr></thead><tbody><tr><td>浏览器渲染</td><td>HTML、CSS、JS…</td></tr><tr><td>图片文件</td><td>JPEG、GIF、PNG…</td></tr><tr><td>视频文件</td><td>FLV、Mp4、AVI…</td></tr><tr><td>其他文件</td><td>TXT、DOC、PDF…</td></tr></tbody></table><p>  浏览器缓存设置用于提高网站性能，尤其是新闻网站，图片一旦发布，改动的可能是非常小的，所以我们希望能否用户访问一次后，图片缓存在用户的浏览器长时间缓存。 浏览器是有自己的缓存机制，他是基于HTTP协议缓存机制来实现的，在HTTP协议中有很多头信息，那么实现浏览器的缓存就需要依赖特殊的头信息来与服务器进行特殊的验证，如Expires（http/1.0）；Cache-control（http/1.1）</p><p>  浏览器缓存过期校验机制：</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/5e71e775f6d5ff1bcc000003.png" alt="bcc"></p><blockquote><p>1、浏览器请求服务器会先进行Expires、Cache-Control的检查，检查缓存是否过期，如果没有过期则直接从缓存文件中读取。<br>2、如果缓存过期首先检查是否存在etag，如果存在那么客户端会向web服务器请求If-None-Match，与etag值进行比对，有服务器决策返回200还是304。<br>3、如果etag不存在，则进行last-Modified检查，客户端会向web服务器请求if-Modified-Since，与last-Modified进行比对，有服务器决策返回200还是304。</p><p>Last-Modified：服务器上文件的最后修改时间<br>Etag：文件标识<br>Expires：本地缓存目录中，文件过期的时间（由服务器指定具体的时间）<br>Cache-control：本地缓存目录中，文件过期的时间（由服务器指定过期的间隔时间，由于浏览器根据间隔生成具体的时间）</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 配置静态资源缓存场景</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name nanxi.com;</span><br><span class="line"></span><br><span class="line">    location ~ .*\.(jpg|gif|png)$ &#123;</span><br><span class="line">        expires      7d;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ .*\.(js|css)$ &#123;</span><br><span class="line">        expires      30d;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">### 如果开发代码没有正式上线，希望静态文件不被缓存</span></span><br><span class="line"><span class="comment"># 取消js、css、html等静态文件缓存</span></span><br><span class="line">location ~ .*\.(js|css|html)$ &#123;</span><br><span class="line">    add_header Cache-Control no-store;</span><br><span class="line">    add_header Pragma no-cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  文件读取高效sendfile，如下图</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: sendfile on | off;</span><br><span class="line">Default: sendfile off;</span><br><span class="line">Context: http, server, location, <span class="keyword">if</span> <span class="keyword">in</span> location</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231222173037014.png" alt="image-20231222173037014"></p><p>  将多个包一次发送，用于提升网络传输效率，大文件推荐打开，需要开启sendfile才行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: tcp_nopush on | off;</span><br><span class="line">Default: tcp_nopush off;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure><p>  提高网络传输实时性，需要开启keepalive，来一个包发一个包不等待行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: tcp_nodelay on | off;</span><br><span class="line">Default: tcpnodelay off;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure><p>  <strong>静态资源压缩  ★★★</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location ~ .*\.(jpg|png|gif) &#123;</span><br><span class="line">    root /code/images;</span><br><span class="line">    <span class="comment">#gzip on;           ### gzip传输压缩，传输前压缩，传输后解压</span></span><br><span class="line">    <span class="comment">#gzip_types image/jpeg image/gif image/png;   ### 指定gzip压缩哪些类型的文件</span></span><br><span class="line">    <span class="comment">#gzip_comp_level 2;   ### 指定gzip压缩比率，加快传输，但压缩本身比较耗费服务器性能</span></span><br><span class="line">    <span class="comment">#gzip_http_version 1.1;    ### gzip压缩协议版本</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  注意：gzip对于压缩图片的比率不太明显，但对于文件的压缩，655K可以压缩到153K压缩的比率很高。</p><h2 id="四、防止资源盗链">四、防止资源盗链</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Syntax: valid_referers none | blocked | server_name | string ...;</span><br><span class="line">Default: -;</span><br><span class="line">Context: server, location</span><br><span class="line"></span><br><span class="line"><span class="comment">#none: referer来源头部为空的情况</span></span><br><span class="line"><span class="comment">#blocked: referer来源头部不为空，这些都不以http://或者https://开头</span></span><br><span class="line"><span class="comment">#server_name: 来源头部信息包含当前域名，可以正则匹配</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location ~ .*\.(jpg|png|gif) &#123;</span><br><span class="line">         root /var/www/wordpress/wp-content/extra/;</span><br><span class="line">         valid_referers none blocked *.nanxi.com;</span><br><span class="line">         <span class="keyword">if</span> ( <span class="variable">$invalid_referer</span> ) &#123;</span><br><span class="line">            <span class="built_in">return</span> 403;   <span class="comment">### 或者可以跳转到自己提前为盗链准备的页面</span></span><br><span class="line">            <span class="comment"># rewrite ^(.*)$ /daolian.png break; </span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231222174825738.png" alt="image-20231222174825738"></p><p>  当然这种防护并不能百分百保证资源不被盗链，因为我们可以通过命令来修改来源的refer信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 伪造协议头访问，因为大多时候我们不会禁止搜索引擎盗链，我们反而需要他们收录我们的信息。</span></span><br><span class="line">curl -e <span class="string">&quot;https://www.baidu.com&quot;</span> -I http://test.nanxi.com/Picture/nanxi.jpg</span><br></pre></td></tr></table></figure><h2 id="五、CPU亲和配置">五、CPU亲和配置</h2><p>  CPU亲和（affinity）减少进程之间不断频繁切换，减少性能损耗，其实现原理是建CPU核心和Nginx工作进程绑定方式，把每个worker进程固定到对应的cpu上执行，减少切换CPU的cache miss，获得更好的性能。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 核心模块中配置</span></span><br><span class="line">worker_processes  auto;</span><br><span class="line">worker_cpu_affinity auto; <span class="comment"># 自动绑定cpu核心，避免cache miss</span></span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231222181928976.png" alt="image-20231222181928976"></p><div class='spoiler collapsed'>    <div class='spoiler-title'>        通用优化配置    </div>    <div class='spoiler-content'>        <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">user www;                   <span class="comment"># nginx进程启动用户</span></span><br><span class="line">worker_processes auto;      <span class="comment">#与cpu核心一致即可</span></span><br><span class="line">worker_cpu_affinity auto;   <span class="comment"># cpu亲和</span></span><br><span class="line"></span><br><span class="line">error_log /var/log/nginx/error.log warn;    <span class="comment"># 错误日志</span></span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line">worker_rlimit_nofile 35535;     <span class="comment">#每个work能打开的文件描述符，调整至1w以上,负荷较高建议2-3w</span></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    use epoll;                  <span class="comment"># 使用epoll高效网络模型 nginx默认就是epoll模型</span></span><br><span class="line">    worker_connections 10240;   <span class="comment"># 限制每个进程能处理多少个连接，10240x[cpu核心]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include             mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line">    charset utf-8;      <span class="comment"># 统一使用utf-8字符集</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义日志格式</span></span><br><span class="line">    log_format  main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#定义json日志格式              </span></span><br><span class="line">    log_format json_access <span class="string">&#x27;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;host&quot;:&quot;$server_addr&quot;,&#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;clientip&quot;:&quot;$remote_addr&quot;,&#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;size&quot;:$body_bytes_sent,&#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;responsetime&quot;:$request_time,&#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;upstreamtime&quot;:&quot;$upstream_response_time&quot;,&#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;upstreamhost&quot;:&quot;$upstream_addr&quot;,&#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;http_host&quot;:&quot;$host&quot;,&#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;url&quot;:&quot;$uri&quot;,&#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;domain&quot;:&quot;$host&quot;,&#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;xff&quot;:&quot;$http_x_forwarded_for&quot;,&#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;referer&quot;:&quot;$http_referer&quot;,&#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;status&quot;:&quot;$status&quot;&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;    <span class="comment"># 访问日志</span></span><br><span class="line"></span><br><span class="line">    server_tokens off;  <span class="comment"># 禁止浏览器显示nginx版本号</span></span><br><span class="line">    client_max_body_size 200m;  <span class="comment"># 文件上传大小限制调整</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 文件高效传输，静态资源服务器建议打开</span></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    <span class="comment"># 文件实时传输，动态资源服务建议打开,需要打开keepalive</span></span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Gzip 压缩</span></span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_disable <span class="string">&quot;MSIE [1-6]\.&quot;</span>;    <span class="comment">#针对IE浏览器不进行压缩</span></span><br><span class="line">    gzip_http_version 1.1;</span><br><span class="line">    gzip_comp_level 2;      <span class="comment">#压缩级别</span></span><br><span class="line">    gzip_buffers 16 8k;     <span class="comment">#压缩的缓冲区</span></span><br><span class="line">    gzip_min_length 1024;   <span class="comment">#文件大于1024字节才进行压缩，默认值20</span></span><br><span class="line">    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript image/jpeg;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 虚拟主机</span></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231222184038687.png" alt="image-20231222184038687"></p>    </div></div><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;Nginx性能优化&lt;/center&gt;&lt;/h1&gt;
&lt;h2 id=&quot;一、性能优化概述&quot;&gt;一、性能优化概述&lt;/h2&gt;
&lt;p&gt;  做事有做事的原则，解决问题有解决问题的方法，那我们在做性能优化工作之前也同样要有自己的逻辑，我们为什么要做优化，我们需要重点考虑哪些方面，和了解哪些方面呢？在南汐看来，一切优化工作的目的就是基于业务稳定安全的前提下尽可能的提高用户的访问体验。&lt;/p&gt;
&lt;p&gt;  1、首先我们需要了解当前系统的结构和瓶颈，当我们的脑袋里存在一个明确的业务框架逻辑时，那么我们对于就会有一个明确的方向。比如了解我们公司当前使用的是什么，运行的是什么业务，都有哪些服务，了解每个服务最大可支撑多少并发，能支持多少qps（每秒查询率）的访问请求，这组系统的最高瓶颈在哪里？&lt;font color=&quot;gray&quot;&gt;&lt;em&gt;（我们如何评定我们系统的瓶颈呢，例如使用top查看系统的CPU负载、内存使用率、总得运行进程等，也可以通过日志去分析请求的情况，也可以通过我们前面介绍到的stub_statius模块查看当前的连接情况，对线上的业务进行压力测试【低峰期】，去了解当前这套系统能承担多少的请求和并发，做好响应的评估。这个是我们做性能优化最先考虑的地方。）&lt;/em&gt;&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;  2、了解业务模式。性能优化是为业务服务的，本质上就是提高业务能力。我们需要了解每个业务接口的类型，比如：电商网站中的抢购模式，这种情况下面，平时没什么流量，但到了抢购时间流量会突增。我们还需要了解系统层次化的结构，比如：我们使用nginx做的是代理、还是动静分离、还是后端直接服务用户，我们要对每一层做好相应的梳理，以便更好的服务业务。&lt;/p&gt;
&lt;p&gt;  3、性能与安全。通常会有这样一个情况，我们往往注重了性能，但是忽略了安全，往往过于注重安全，对性能又会产生影响。比如：我们在设计防火墙功能时，检测过于严密，这样就会给性能带来影响。那么如果对于性能完全追求，却不顾服务的安全，也会造成很大的隐患。我们需要评估好两者的关系，把握好两者的孰重孰轻。以及整体的相关性，权衡好对应的点。&lt;/p&gt;
&lt;h2 id=&quot;二、压力测试工具&quot;&gt;二、压力测试工具&lt;/h2&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@web1 ~]&lt;span class=&quot;comment&quot;&gt;#yum -y install httpd-tools&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[root@web1 ~]&lt;span class=&quot;comment&quot;&gt;#ab -k -c100 -n1000 http://nanxi.com/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;### -n 要执行的请求数  -c 请求的并发数  -k 是否开启长连接&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;  我们可以先以自己的静态网页为例（现在很多的网站基本都会设置屏蔽外界压测），来做一个小测试：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231222163408848.png&quot; alt=&quot;image-20231222163408848&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="服务架构" scheme="https://smallflames.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>Keepalived高可用</title>
    <link href="https://smallflames.github.io/2023/12/20/Keepalived%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    <id>https://smallflames.github.io/2023/12/20/Keepalived%E9%AB%98%E5%8F%AF%E7%94%A8/</id>
    <published>2023-12-20T13:08:46.000Z</published>
    <updated>2023-12-21T14:19:31.763Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>Keepalived高可用</center></h1><h2 id="一、Keepalived基本简述">一、Keepalived基本简述</h2><p>  高可用一般是指<mark>2台机器启动着完全相同的业务系统</mark>，当有<mark>一台机器down机</mark>了，<mark>另外一台服务器</mark>就能快速的接管，这种<mark>快速接管</mark>对于访问的用户是无感知的。高可用的实现方式通常有两种：<strong>硬件实现高可用（F5）、软件实现高可用（Keepalived）</strong>，我们主要讲解通过Keepalived实现高可用。</p><p>  keepalived软件是基于VRRP协议实现的，主要用于解决单点故障问题。</p><p>  虚拟路由冗余协议(Virtual Router Redundancy Protocol，简称VRRP)是由IETF提出的解决局域网中配置静态网关出现单点失效现象的路由协议。利用VRRP，一组路由器（同一个VLAN中的接口）协同工作，但只要一个处于Master状态，处于该状态的路由器接口承担实际数据流量的转发任务。在一个VRRP组内的多个路由器接口共用一个虚拟IP地址，该地址被作为局域网内所有主机的缺省网关地址。</p><span id="more"></span><h2 id="二、Keepalived高可用安装配置">二、Keepalived高可用安装配置</h2><table><thead><tr><th>作用</th><th>IP</th><th style="text-align:left">角色</th></tr></thead><tbody><tr><td>VIP（虚拟IP）</td><td>192.168.10.234</td><td style="text-align:left">虚拟IP地址</td></tr><tr><td>node1</td><td>192.168.10.6</td><td style="text-align:left">Master</td></tr><tr><td>node2</td><td>192.168.10.11</td><td style="text-align:left">Backup</td></tr></tbody></table><p>  详细配置介绍如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@lb03 ~]<span class="comment">#yum -y install keepalived</span></span><br><span class="line">[root@lb03 ~]<span class="comment">#systemctl start keepalived</span></span><br><span class="line">[root@lb03 ~]<span class="comment">#systemctl enable keepalived</span></span><br><span class="line">[root@lb03 ~]<span class="comment">#cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id lb02/lb03     <span class="comment">### 标记服务器id可自定义</span></span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP/MASTER     <span class="comment">### 身份状态标识主/备 keepalived默认是抢占模式，抢占式只要主设备的keepalived服务存活，会直接抢占虚拟IP</span></span><br><span class="line">    interface eth0          <span class="comment">### 网卡绑定接口，在网卡eth0上生成虚拟IP</span></span><br><span class="line">    virtual_router_id 50    <span class="comment">### 小组标识id，两台部署了keepalived服务的主机，通过这个标识判断是否为同一小组</span></span><br><span class="line">    <span class="comment">### 同一小组的主机可以接受对方的心跳报文（心跳报文用来向对方确认自己的运行状态）</span></span><br><span class="line">    priority 100            <span class="comment">### 优先级，同一小组内的主机以票数最终决定主/备</span></span><br><span class="line">    advert_int 1            <span class="comment">### 监测间隔时间</span></span><br><span class="line">    <span class="comment"># nopreempt   设置非抢占式，主服务器重新存活，不会自动抢占虚拟IP，注意非抢占式的两台服务器身份标识必须一致</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS      <span class="comment">### 认证方式，通过密码验证</span></span><br><span class="line">        auth_pass 1111      <span class="comment">### 主/备服务器的密码必须保持一致，否则无法接收心跳报文</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.10.234      <span class="comment">### 虚拟IP（部署keepalived服务的两台服务器，若有一台down掉，虚拟IP会自动飘移至另一台）</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  实例测试：（抢占式）</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231221203538266.png" alt="image-20231221203538266"></p><p>  实例测试：（非抢占式）</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231221210328288.png" alt="image-20231221210328288"></p><h2 id="三、高可用keepalived故障脑裂">三、高可用keepalived故障脑裂</h2><p>  当两台高可用服务器在指定的时间内，无法互相检测到对方心跳而各自启动故障转移功能，取得了资源以及服务的所有权，而此时的两台高可用服务器对都还活着并作正常运行，这样就会导致同一个服务在两端同时启动而发生冲突的严重问题，最严重的就是两台主机同时占用一个VIP的地址（类似双端导入概念），当用户写入数据的时候可能会分别写入到两端，这样可能会导致服务器两端的数据不一致或造成数据的丢失，这种情况就称为脑裂。<em><font color="gray">（脑裂的可能原因：①高可用服务器对之间心跳线路故障，导致无法正常的通信、②服务器网线松动等网络故障、③服务器硬件故障发生损坏现象而崩溃、④主备都开启firewalld防火墙…）</font></em> 脑裂的解决方案如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#如果发生闹裂，则随机kill掉一台即可</span></span><br><span class="line"><span class="comment">#在备上编写检测脚本, 测试如果能ping通主并且备节点还有VIP的话则认为产生了裂脑</span></span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line">vip=192.168.10.234</span><br><span class="line">lb02_ip=192.168.10.6</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>;<span class="keyword">do</span></span><br><span class="line">    ping -c 2 <span class="variable">$lb02_ip</span> &amp;&gt;/dev/null</span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 -a `ip add|grep <span class="string">&quot;<span class="variable">$vip</span>&quot;</span>|<span class="built_in">wc</span> -l` -eq 1 ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;this is split brain.warning.&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;this is ok&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="built_in">sleep</span> 5</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h2 id="四、高可用keepalived与nginx结合">四、高可用keepalived与nginx结合</h2><p>  为什么域名解析到VIP就可以访问nginx？Nginx默认监听在所有的IP地址上，VIP会飘到一台节点上，相当于那台nginx多了VIP这么一个网卡，所以可以访问到nginx所在机器，<strong>但是……如果nginx宕机，会导致用户请求失败，但是keepalived没有挂掉就不会进行切换，此时用户访问就会出问题</strong>，所以需要编写一个脚本检测Nginx的存活状态，如果nginx不存活则主动kill掉keepalived，让虚拟IP漂移到下一台nginx代理。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">nginxpid=$(ps -C nginx --no-header|<span class="built_in">wc</span> -l)</span><br><span class="line"></span><br><span class="line"><span class="comment">#1.判断Nginx是否存活,如果不存活则尝试启动Nginx</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$nginxpid</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">    systemctl start nginx</span><br><span class="line">    <span class="built_in">sleep</span> 3</span><br><span class="line">    <span class="comment">#2.等待3秒后再次获取一次Nginx状态</span></span><br><span class="line">    nginxpid=$(ps -C nginx --no-header|<span class="built_in">wc</span> -l) </span><br><span class="line">    <span class="comment">#3.再次进行判断, 如Nginx还不存活则停止Keepalived,让地址进行漂移,并退出脚本  </span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$nginxpid</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">        systemctl stop keepalived</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment">#给脚本增加执行权限</span></span><br><span class="line">[root@lb02 ~]<span class="comment"># chmod +x /root/check_web.sh</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">在lb02主机的keepalived配置文件中调用此脚</span><br><span class="line">[root@lb02 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">global_defs &#123;           </span><br><span class="line">    router_id lb02      </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#每5秒执行一次脚本，脚本执行内容不能超过5秒，否则会中断再次重新执行脚本</span></span><br><span class="line">vrrp_script check_web &#123;</span><br><span class="line">    script <span class="string">&quot;/root/check_web.sh&quot;</span></span><br><span class="line">    interval 5</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER        </span><br><span class="line">    interface eth0      </span><br><span class="line">    virtual_router_id 50    </span><br><span class="line">    priority 150        </span><br><span class="line">    advert_int 1        </span><br><span class="line">    authentication &#123;    </span><br><span class="line">        auth_type PASS  </span><br><span class="line">        auth_pass 1111  </span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123; </span><br><span class="line">        192.168.10.234    </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#调用并运行脚本</span></span><br><span class="line">     track_script &#123;</span><br><span class="line">     check_web</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">### 抢占式，仅需在master配置即可。如果配置为非抢占式，那么需要两台服务器都使用该脚本!!!</span></span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;Keepalived高可用&lt;/center&gt;&lt;/h1&gt;
&lt;h2 id=&quot;一、Keepalived基本简述&quot;&gt;一、Keepalived基本简述&lt;/h2&gt;
&lt;p&gt;  高可用一般是指&lt;mark&gt;2台机器启动着完全相同的业务系统&lt;/mark&gt;，当有&lt;mark&gt;一台机器down机&lt;/mark&gt;了，&lt;mark&gt;另外一台服务器&lt;/mark&gt;就能快速的接管，这种&lt;mark&gt;快速接管&lt;/mark&gt;对于访问的用户是无感知的。高可用的实现方式通常有两种：&lt;strong&gt;硬件实现高可用（F5）、软件实现高可用（Keepalived）&lt;/strong&gt;，我们主要讲解通过Keepalived实现高可用。&lt;/p&gt;
&lt;p&gt;  keepalived软件是基于VRRP协议实现的，主要用于解决单点故障问题。&lt;/p&gt;
&lt;p&gt;  虚拟路由冗余协议(Virtual Router Redundancy Protocol，简称VRRP)是由IETF提出的解决局域网中配置静态网关出现单点失效现象的路由协议。利用VRRP，一组路由器（同一个VLAN中的接口）协同工作，但只要一个处于Master状态，处于该状态的路由器接口承担实际数据流量的转发任务。在一个VRRP组内的多个路由器接口共用一个虚拟IP地址，该地址被作为局域网内所有主机的缺省网关地址。&lt;/p&gt;</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="服务架构" scheme="https://smallflames.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>rewrite重写和https跳转</title>
    <link href="https://smallflames.github.io/2023/12/19/rewrite%E9%87%8D%E5%86%99%E5%92%8Chttps%E8%B7%B3%E8%BD%AC/"/>
    <id>https://smallflames.github.io/2023/12/19/rewrite%E9%87%8D%E5%86%99%E5%92%8Chttps%E8%B7%B3%E8%BD%AC/</id>
    <published>2023-12-19T10:38:58.000Z</published>
    <updated>2023-12-20T13:43:52.899Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>rewrite重写和https跳转</center></h1><h2 id="一、Nginx实现Rewrite重写">一、Nginx实现Rewrite重写</h2><p>  Rewrite主要实现url地址重写，以及重定向，就是把传入web的请求重定向到其他url的过程。、</p><h3 id="1、Rewrite使用场景">1、Rewrite使用场景</h3><blockquote><p>1、地址跳转，用户访问www.nanxi.com这个URL时，将其定向至一个新的域名 <a href="http://m.nanxi.com">m.nanxi.com</a><br>2、协议跳转，用户通过http协议请求网站时，将其重新跳转至https协议方式<br>3、伪静态，将动态页面显示为静态页面方式的一种技术，便于搜索引擎的录入，同时减少动态URL地址对外暴露过多的参数，提升更高的安全性。<br>4、搜索引擎，SEO优化依赖于url路径，好记的url便于支持搜索引擎录入。</p></blockquote><h3 id="2、Rewrite配置示例">2、Rewrite配置示例</h3><p>  rewrite指令根据表达式来重定向URL，或者修改字符串，可以应用于server，location，if环境下，每行rewrite指令最后跟一个flag标记，支持的flag标记有如下表格所示：</p><table><thead><tr><th>flag</th><th>作用</th></tr></thead><tbody><tr><td>last</td><td>本条规则匹配完成后，停止本location匹配，重新以本条结果发请求</td></tr><tr><td>break</td><td>本条规则匹配完成后，停止本location匹配，直接返回本条请求内容</td></tr><tr><td>redirect</td><td>返回302临时重定向，地址栏会显示跳转后的地址，每一次访问都会访问源站</td></tr><tr><td>permanent</td><td>返回301永久重定向，地址栏会显示跳转后的地址，只有第一次访问时是源站</td></tr></tbody></table><span id="more"></span><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219192227948.png" alt="image-20231219192227948"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219191614582.png" alt="image-20231219191614582"></p><p>  注意，直接访问nanxi.com时，会显示403，因为我们没有配置index.html文件。没有添加标记时如下：</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219192709141.png" alt="image-20231219192709141"></p><p>  当我们在配置中的rewrite后面添加flag标记时显示效果如下：</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219194001114.png" alt="image-20231219194001114"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219194441074.png" alt="image-20231219194441074"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219195930180.png" alt="image-20231219195930180"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219201249341.png" alt="image-20231219201249341"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219202036927.png" alt="image-20231219202036927"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219202451564.png" alt="image-20231219202451564"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219203608235.png" alt="image-20231219203608235"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219204910828.png" alt="image-20231219204910828"></p><div class='spoiler collapsed'>    <div class='spoiler-title'>        Nginx内置参数    </div>    <div class='spoiler-content'>        <p>$args                                   #这个变量等于请求行中的参数。<br>$content_length                #请求头中的Content-length字段。<br>$content_type                   #请求头中的Content-Type字段。<br>$document_root               #当前请求在root指令中指定的值。<br>$host                                  #请求主机头字段，否则为服务器名称。<br>$http_user_agent             #客户端agent信息<br>$http_cookie                     #客户端cookie信息<br>$limit_rate                         #这个变量可以限制连接速率。<br>$request_body_file          #客户端请求主体信息的临时文件名。<br>$request_method            #客户端请求的动作，通常为GET或POST。<br>$remote_addr                  #客户端的IP地址。<br>$remote_port                   #客户端的端口。<br>$remote_user                  #已经经过Auth Basic Module验证的用户名。<br>$request_filename          #当前请求的文件路径，由root或alias指令与URI请求生成。<br>$query_string                   #与$args相同。<br>$scheme                           #HTTP方法（如http，https）。<br>$server_protocol             #请求使用的协议，通常是HTTP/1.0或HTTP/1.1。<br>$server_addr                    #服务器地址，在完成一次系统调用后可以确定这个值。<br>$server_name                  #服务器名称。<br>$server_port                    #请求到达服务器的端口号。<br>$request_uri                    #包含请求参数的原始URI，不包含主机名，如：”/foo/bar.php?arg=baz”。<br>$uri                                    #不带请求参数的当前URI，$uri不包含主机名，如”/foo/bar.html”。<br>$document_uri               #与$uri相同。</p><p>$X-Forwarded-For:HTTP的请求端真实的IP，只有在通过了HTTP 代理或者负载均衡服务器时才会添加该项。标准格式如下：X-Forwarded-For: client1, proxy1, proxy2</p>    </div></div><h2 id="二、Ningx-HTTPS-实践">二、Ningx HTTPS 实践</h2><p>  为什么需要使用HTTPS，因为HTTP不安全，当我们使用http网站时，会遭到劫持和篡改，如果采用https协议，那么数据在传输过程中是加密的，所以黑客无法窃取或者篡改数据报文信息，同时也避免网站传输时信息泄露，我们现在使用的更多的是TLS加密协议。</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219205244667.png" alt="image-20231219205244667"></p><h3 id="1、SSL加密过程">1、SSL加密过程</h3><p>  在数据进行加密与解密过程中，如何确定双方的身份，此时就需要有一个权威机构来验证双方身份，那么这个权威机构就是CA机构，CA机构颁发证书的过程如下：</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219205556939.png" alt="image-20231219205556939"></p><p>  我们申请证书时需要先去登记机构进行身份登记，我是谁，我是什么单位，我是干嘛的，我想做什么，然后登记机构再通过CSR发给CA，CA中心通过后会生成一堆公钥和私钥，公钥会在CA证书链中保存，公钥和私钥证书我们拿到后，会将其部署在WEB服务器上，当浏览器访问我们的https站点时，它会去请求我们的证书，Nginx这样的web服务器会将我们证书的公钥发给浏览器，浏览器会去验证我们的证书是否合法。</p><blockquote><p><strong>详细流程</strong></p><p>1、浏览器发起往服务器的443端口发起请求，请求携带了浏览器支持的加密算法和哈希算法。<br>2、服务器收到请求，选择浏览器支持的加密算法和哈希算法。<br>3、服务器下将数字证书返回给浏览器，这里的数字证书可以是向某个可靠机构申请的，也可以是自制的。<br>4、浏览器进入数字证书认证环节，这一部分是浏览器内置的TLS完成的：首先浏览器会从内置的证书列表中索引，找到服务器下发证书对应的机构，如果没有找到，此时就会提示用户该证书是不是由权威机构颁发，是不可信任的。如果查到了对应的机构，则取出该机构颁发的公钥。用机构的证书公钥解密得到证书的内容和证书签名，内容包括网站的网址、网站的公钥、证书的有效期等。浏览器会先验证证书签名的合法性（验证过程类似上面Bob和Susan的通信）。签名通过后，浏览器验证证书记录的网址是否和当前网址是一致的，不一致会提示用户。如果网址一致会检查证书有效期，证书过期了也会提示用户。这些都通过认证时，浏览器就可以安全使用证书中的网站公钥了。浏览器会生成一个随机数R，并使用网站公钥对R进行加密。<br>5、浏览器将加密的R传送给服务器。<br>6、服务器用自己的私钥解密得到R。<br>7、服务器以R为密钥使用了对称加密算法加密网页内容并传输给浏览器。<br>8、浏览器以R为密钥使用之前约定好的解密算法获取网页内容。</p></blockquote><p>  <strong>使用HTTP协议模拟网站被篡改</strong></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219211323573.png" alt="image-20231219211323573"></p><p>  此时我们打开另一台服务器，对192.168.10.200进行劫持，这台服务器等同于代理我们去访问（当然现实过程中我们是不知道的）192.168.10.200这个IP，然后返回给我们的可能是它修改过的内容！</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219212959089.png" alt="image-20231219212959089"></p><h3 id="2、SSL证书类型介绍">2、SSL证书类型介绍</h3><table><thead><tr><th>对比</th><th>域名型 DV</th><th>企业型 OV</th><th>增强型 EV</th></tr></thead><tbody><tr><td>一般用途</td><td>个人站点和应用；<br /> 简单的加密需求</td><td>电子商务站点和应用；<br /> 中小型企业站点</td><td>大型金融平台；<br /> 大型企业和政府机构站点</td></tr><tr><td>审核内容</td><td>域名所有权验证</td><td>全面的企业身份验证； <br />域名所有权验证</td><td>最高等级的企业身份验证；<br /> 域名所有权验证</td></tr><tr><td>颁发时长</td><td>10分钟-24小时</td><td>3-5个工作日</td><td>5-7个工作日</td></tr><tr><td>单次申请年限</td><td>3个月</td><td>1-2年</td><td>1-2年</td></tr><tr><td>赔付保障金</td><td>——</td><td>125-175万美金</td><td>150-175万美金</td></tr></tbody></table><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219213804568.png" alt="image-20231219213804568"></p><blockquote><p>https不支持续费，证书到期需要重新申请并进行替换<br>https不支持三级域名解析，如 <a href="http://test.m.nanxi.com">test.m.nanxi.com</a><br>https显示绿色，说明整个网站的url都是https保护的<br>https显示黄色，因为网站代码中包含http的不安全链接<br>https显示红色，那么证书是假的或者证书过期。</p></blockquote><h3 id="3、Nginx-自签证实现HTTPS">3、Nginx 自签证实现HTTPS</h3><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219214520781.png" alt="image-20231219214520781"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219215115983.png" alt="image-20231219215115983"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219215327225.png" alt="image-20231219215327225"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231219214947233.png" alt="image-20231219214947233"></p><h3 id="4、Web集群实现HTTPS">4、Web集群实现HTTPS</h3><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231220213207285.png" alt="image-20231220213207285"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231220213359427.png" alt="image-20231220213359427"></p><p>注意⚠️ ： <mark>证书只配到负载均衡上即可，如果负载均衡配置了https协议，相应的web端也必须支持https协议，否则页面会出现无样式的现象，同样的，如果web设置支持https但是没有使用跳转https，会出现同样的无样式的情况，且访问极慢。</mark>（一旦设置支持https协议，那么所有的页面都会按照https的原理运行，默认的http协议将不再被运行！）</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;rewrite重写和https跳转&lt;/center&gt;&lt;/h1&gt;
&lt;h2 id=&quot;一、Nginx实现Rewrite重写&quot;&gt;一、Nginx实现Rewrite重写&lt;/h2&gt;
&lt;p&gt;  Rewrite主要实现url地址重写，以及重定向，就是把传入web的请求重定向到其他url的过程。、&lt;/p&gt;
&lt;h3 id=&quot;1、Rewrite使用场景&quot;&gt;1、Rewrite使用场景&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;1、地址跳转，用户访问www.nanxi.com这个URL时，将其定向至一个新的域名 &lt;a href=&quot;http://m.nanxi.com&quot;&gt;m.nanxi.com&lt;/a&gt;&lt;br&gt;
2、协议跳转，用户通过http协议请求网站时，将其重新跳转至https协议方式&lt;br&gt;
3、伪静态，将动态页面显示为静态页面方式的一种技术，便于搜索引擎的录入，同时减少动态URL地址对外暴露过多的参数，提升更高的安全性。&lt;br&gt;
4、搜索引擎，SEO优化依赖于url路径，好记的url便于支持搜索引擎录入。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;2、Rewrite配置示例&quot;&gt;2、Rewrite配置示例&lt;/h3&gt;
&lt;p&gt;  rewrite指令根据表达式来重定向URL，或者修改字符串，可以应用于server，location，if环境下，每行rewrite指令最后跟一个flag标记，支持的flag标记有如下表格所示：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;flag&lt;/th&gt;
&lt;th&gt;作用&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;last&lt;/td&gt;
&lt;td&gt;本条规则匹配完成后，停止本location匹配，重新以本条结果发请求&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;break&lt;/td&gt;
&lt;td&gt;本条规则匹配完成后，停止本location匹配，直接返回本条请求内容&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;redirect&lt;/td&gt;
&lt;td&gt;返回302临时重定向，地址栏会显示跳转后的地址，每一次访问都会访问源站&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;permanent&lt;/td&gt;
&lt;td&gt;返回301永久重定向，地址栏会显示跳转后的地址，只有第一次访问时是源站&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="服务架构" scheme="https://smallflames.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>shell脚本篇001</title>
    <link href="https://smallflames.github.io/2023/12/18/shell%E8%84%9A%E6%9C%AC%E7%AF%87001/"/>
    <id>https://smallflames.github.io/2023/12/18/shell%E8%84%9A%E6%9C%AC%E7%AF%87001/</id>
    <published>2023-12-18T12:28:21.000Z</published>
    <updated>2023-12-18T12:42:22.935Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>shell脚本篇001</center></h1><table><tr><td bgcolor=#000000><font color="white">实现效果</font></td></tr></table><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231218203518420.png" alt="image-20231218203518420"></p><span id="more"></span><table><tr><td bgcolor=#000000><font color="white">实现脚本</font></td></tr></table><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231218203649018.png" alt="image-20231218203649018"></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;shell脚本篇001&lt;/center&gt;&lt;/h1&gt;
&lt;table&gt;&lt;tr&gt;&lt;td bgcolor=#000000&gt;&lt;font color=&quot;white&quot;&gt;实现效果&lt;/font&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231218203518420.png&quot; alt=&quot;image-20231218203518420&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="shell脚本" scheme="https://smallflames.github.io/tags/shell%E8%84%9A%E6%9C%AC/"/>
    
  </entry>
  
  <entry>
    <title>nginx实现动静分离</title>
    <link href="https://smallflames.github.io/2023/12/18/nginx%E5%AE%9E%E7%8E%B0%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB/"/>
    <id>https://smallflames.github.io/2023/12/18/nginx%E5%AE%9E%E7%8E%B0%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB/</id>
    <published>2023-12-18T09:43:50.000Z</published>
    <updated>2023-12-18T12:19:49.556Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>Nginx实现动静分离</center></h1><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231218180340246.png" alt="image-20231218180340246"></p><table><tr><td bgcolor=#000000><font color="white">环境准备</font></td></tr></table><table><thead><tr><th>角色</th><th>IP地址</th></tr></thead><tbody><tr><td>负载均衡（lb）</td><td>192.168.10.3</td></tr><tr><td>web1（静态资源）</td><td>192.168.10.200</td></tr><tr><td>web2（动态资源）</td><td>192.168.10.201</td></tr></tbody></table><table><tr><td bgcolor=#000000><font color="white">实现过程</font></td></tr></table><p>1️⃣ web1配置静态资源；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@web1 /etc/nginx/conf.d]<span class="comment">#vim nanxi.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        root /code;</span><br><span class="line">charset utf-8,gbk;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">        index index.html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">[root@web1 /code]<span class="comment">#echo &#x27;&lt;h1&gt;&lt;center&gt;南汐666520&lt;/center&gt;&lt;/h1&gt;&#x27; &gt;index.html</span></span><br></pre></td></tr></table></figure><span id="more"></span><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231218182450047.png" alt="image-20231218182450047"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231218183337107.png" alt="image-20231218183337107"></p><p>2️⃣ web2配置一个动态资源；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@web2 ~]<span class="comment">#yum -y install tomcat</span></span><br><span class="line">...</span><br><span class="line">[root@web2 ~]<span class="comment">#yum -y install java</span></span><br><span class="line">...</span><br><span class="line">[root@web2 ~]<span class="comment">#mkdir /usr/share/tomcat/webapps/ROOT</span></span><br><span class="line">[root@web2 /usr/share/tomcat/webapps/ROOT]<span class="comment">#cat java_test.jsp</span></span><br><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> import=<span class="string">&quot;java.util.*&quot;</span> pageEncoding=<span class="string">&quot;utf-8&quot;</span>%&gt;</span><br><span class="line">&lt;HTML&gt;</span><br><span class="line">    &lt;HEAD&gt;</span><br><span class="line">        &lt;TITLE&gt;nanxi JSP Page&lt;/TITLE&gt;</span><br><span class="line">    &lt;/HEAD&gt;</span><br><span class="line">    &lt;BODY&gt;</span><br><span class="line">        &lt;%</span><br><span class="line">            Random rand = new Random();</span><br><span class="line">            out.println(<span class="string">&quot;&lt;h1&gt;显示随机数:&lt;h1&gt;&quot;</span>);</span><br><span class="line">            out.println(rand.nextInt(99)+100);</span><br><span class="line">        %&gt;</span><br><span class="line">    &lt;/BODY&gt;</span><br><span class="line">&lt;/HTML&gt;</span><br><span class="line">测试访问如下，8080为tomcat的默认端口</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231218184749984.png" alt="image-20231218184749984"></p><p>3️⃣ 集成至负载均衡；（测试时记得修改hosts文件）</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231218185513220.png" alt="image-20231218185513220"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231218192640980.png" alt="image-20231218192640980"></p><p>最后集成显示的效果如下：</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231218192730094.png" alt="image-20231218192730094"></p><div class="tips"><p><strong>Nginx资源分离知识补充</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@lb /code]#mkdir android</span><br><span class="line">[root@lb /code]#mkdir iphone</span><br><span class="line">[root@lb /code]#mkdir pc</span><br><span class="line">[root@lb /code]#echo &quot;我是安卓页面&quot; &gt; /code/android/index.html</span><br><span class="line">[root@lb /code]#echo &quot;我是iphone页面&quot; &gt; /code/iphone/index.html</span><br><span class="line">[root@lb /code]#echo &quot;我是电脑页面&quot; &gt; /code/pc/index.html</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231218194228518.png" alt="image-20231218194228518"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231218195944060.png" alt="image-20231218195944060"></p><p>实现效果如下：</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231218200416983.png" alt="image-20231218200416983"></p><p>实际企业中不会分的那么清楚，代码资源一般只分移动端和PC端；</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231218200957554.png" alt="image-20231218200957554"></p></div><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;Nginx实现动静分离&lt;/center&gt;&lt;/h1&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231218180340246.png&quot; alt=&quot;image-20231218180340246&quot;&gt;&lt;/p&gt;
&lt;table&gt;&lt;tr&gt;&lt;td bgcolor=#000000&gt;&lt;font color=&quot;white&quot;&gt;环境准备&lt;/font&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;角色&lt;/th&gt;
&lt;th&gt;IP地址&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;负载均衡（lb）&lt;/td&gt;
&lt;td&gt;192.168.10.3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;web1（静态资源）&lt;/td&gt;
&lt;td&gt;192.168.10.200&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;web2（动态资源）&lt;/td&gt;
&lt;td&gt;192.168.10.201&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table&gt;&lt;tr&gt;&lt;td bgcolor=#000000&gt;&lt;font color=&quot;white&quot;&gt;实现过程&lt;/font&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;p&gt;1️⃣ web1配置静态资源；&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@web1 /etc/nginx/conf.d]&lt;span class=&quot;comment&quot;&gt;#vim nanxi.conf&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;server &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        listen 80;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        root /code;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		charset utf-8,gbk;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        location / &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        index index.html;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[root@web1 /code]&lt;span class=&quot;comment&quot;&gt;#echo &amp;#x27;&amp;lt;h1&amp;gt;&amp;lt;center&amp;gt;南汐666520&amp;lt;/center&amp;gt;&amp;lt;/h1&amp;gt;&amp;#x27; &amp;gt;index.html&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="服务架构" scheme="https://smallflames.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>LNMP架构部署动态产品</title>
    <link href="https://smallflames.github.io/2023/12/13/LNMP%E6%9E%B6%E6%9E%84%E9%83%A8%E7%BD%B2%E5%8A%A8%E6%80%81%E4%BA%A7%E5%93%81/"/>
    <id>https://smallflames.github.io/2023/12/13/LNMP%E6%9E%B6%E6%9E%84%E9%83%A8%E7%BD%B2%E5%8A%A8%E6%80%81%E4%BA%A7%E5%93%81/</id>
    <published>2023-12-13T12:13:47.000Z</published>
    <updated>2023-12-13T15:03:31.669Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>LNMP架构部署动态产品</center></h1><h2 id="一、LNMP架构概述">一、LNMP架构概述</h2><p>LNMP是一套技术的组合，L = Linux、N = Nginx、M = MySQL、P = PHP，其工作原理如下：</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231213204833175.png" alt="image-20231213204833175"></p><blockquote><p>1.用户通过http协议发起请求，请求会先抵达LNMP架构中的Nginx<br>2.Nginx会根据用户的请求进行判断，这个判断是有Location进行完成<br>3.判断用户请求的是静态页面，Nginx直接进行处理<br>4.判断用户请求的是动态页面，Nginx会将该请求交给fastcgi协议下发<br>5.fastgi会将请求交给php-fpm管理进程, php-fpm管理进程接收到后会调用工作进程warrap工作<br>6.warrap进程会调用php程序进行解析,如果只是解析代码php直接返回<br>7.如果有查询数据库操作，则由php连接数据库(用户 密码 IP)发起查询的操作<br>8.最终数据由 mysql-&gt;php-&gt;php-fpm-&gt;fastcgi-&gt;nginx-&gt;http-&gt;user</p></blockquote><h2 id="二、Nginx-PHP演示">二、Nginx+PHP演示</h2><table><thead><tr><th>服务准备</th><th>IP地址</th><th>主机名</th></tr></thead><tbody><tr><td>Nginx、PHP</td><td>192.168.10.200</td><td>web1</td></tr></tbody></table><p>nginx前面我们已经讲述过了，三种方式均可，这里不再赘述，我们简要说一下PHP服务和数据库的安装。</p><span id="more"></span><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</span></span><br><span class="line"><span class="comment"># rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm</span></span><br><span class="line"></span><br><span class="line">[root@web1 ~]<span class="comment"># yum remove php-mysql-5.4 php php-fpm php-common</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置第三方源</span></span><br><span class="line">[root@web1 ~]<span class="comment"># vim /etc/yum.repos.d/php.repo</span></span><br><span class="line">[php-webtatic]</span><br><span class="line">name = PHP Repository</span><br><span class="line">baseurl = http://us-east.repo.webtatic.com/yum/el7/x86_64/</span><br><span class="line">gpgcheck = 0</span><br><span class="line"></span><br><span class="line">[root@web1 ~]<span class="comment"># yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb --nogpgcheck</span></span><br><span class="line"></span><br><span class="line">[root@web1 ~]<span class="comment"># systemctl start php-fpm</span></span><br><span class="line">[root@web1 ~]<span class="comment"># systemctl enable php-fpm</span></span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231213211209039.png" alt="image-20231213211209039"></p><p>我们需要保持Nginx服务和PHP服务的用户是一致的，最后效果如上图☝️</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231213212408114.png" alt="image-20231213212408114"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置fastcgi服务器的地址，该地址可以指定为域名或IP地址，以及端口</span></span><br><span class="line">fastcgi_pass 127.0.0.1:9000;</span><br><span class="line"></span><br><span class="line">fastcgi_index index.php; <span class="comment">### 设置fastcgi默认的首页文件，需要结合fastcgi_param一起设置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过fastcgi_param设置变量，并将设置的变量传递到后端的fastcgi服务器</span></span><br><span class="line">fastcgi_param SCRIPT_FILENAME $document_root<span class="variable">$fastcgi_script_name</span>;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231213213156484.png" alt="image-20231213213156484"></p><p>在/code目录下创建index.php文件，测试能否通过浏览器访问，访问成功如下图：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@web1 /etc/nginx/conf.d]<span class="comment">#cat /code/index.php</span></span><br><span class="line">&lt;?php</span><br><span class="line">    phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231213213558004.png" alt="image-20231213213558004"></p><h2 id="三、LNMP部署博客产品WordPress">三、LNMP部署博客产品WordPress</h2><table><thead><tr><th>服务准备</th><th>IP地址</th><th>主机名</th></tr></thead><tbody><tr><td>Nginx、PHP</td><td>192.168.10.200</td><td>web1</td></tr><tr><td>数据库（mariadb）</td><td>192.168.10.2</td><td>db01</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### wordpress 产品是需要依赖数据库的，现在市面上几乎所有的业务都是需要数据库支持的</span></span><br><span class="line">[root@db01 ~]<span class="comment">#yum -y install mariadb-server   ### 安装数据库</span></span><br><span class="line">[root@db01 ~]<span class="comment">#systemctl start mariadb         </span></span><br><span class="line">[root@db01 ~]<span class="comment">#systemctl enable mariadb</span></span><br><span class="line">[root@db01 ~]<span class="comment">#mysqladmin password &#x27;nanxi123&#x27;  ### 设置数据库管理员密码</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载WordPress代码</span></span><br><span class="line">[root@web1 ~]<span class="comment">#mkdir -p /code/wordpress</span></span><br><span class="line">[root@web1 /code/wordpress]<span class="comment">#wget https://cn.wordpress.org/wordpress-5.0.3-zh_CN.tar.gz</span></span><br><span class="line">[root@web1 /code/wordpress]<span class="comment">#tar xf wordpress-5.0.3-zh_CN.tar.gz</span></span><br><span class="line">[root@web1 /code/wordpress]<span class="comment">#chown -R www.www /code</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库配置</span></span><br><span class="line">[root@db01 ~]<span class="comment">#mysql -uroot -pnanxi123</span></span><br><span class="line">MariaDB [(none)]&gt; create database wordpress;</span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">| wordpress          |</span><br><span class="line">+--------------------+</span><br><span class="line">[root@db01 ~]<span class="comment">#mysql -uroot -pnanxi123 -e &quot;grant all on  *.* to nanxi@&#x27;%&#x27; identified by &#x27;nanxi123&#x27;;&quot;    # 允许普通用户远程连接数据库</span></span><br><span class="line">[root@db01 ~]<span class="comment">#netstat -lntup | grep 3306</span></span><br><span class="line">tcp     0   0 0.0.0.0:3306       0.0.0.0:*        LISTEN      20186/mysqld</span><br><span class="line">[root@db01 ~]<span class="comment">#telnet 192.168.10.2 3306    ### 测试数据库远程连接是否可用</span></span><br><span class="line">Trying 192.168.10.2...                    <span class="comment">### 切记要关闭防火墙，否则数据库是无法远程连接的！！！</span></span><br><span class="line">Connected to 192.168.10.2.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br><span class="line">R</span><br><span class="line">5.5.68-MariaDBсa.^n1GP ztV3&lt;o&gt;(J&#125;Vumysql_native_password <span class="comment">### 表示数据库远程连接可用 </span></span><br><span class="line">[root@web1 ~]<span class="comment">#mysql -h192.168.10.2 -unanxi -pnanxi123 ### 测试数据库远程连接是否可用</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection <span class="built_in">id</span> is 470</span><br><span class="line">Server version: 5.5.68-MariaDB MariaDB Server</span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line">MariaDB [(none)]&gt;                                     <span class="comment">### 表示数据库远程连接可用</span></span><br></pre></td></tr></table></figure><p>在wordpress的数据库配置文件（/code/wordpress/wp-config.php）中配置远程数据库连接：</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231213224400499.png" alt="image-20231213224400499"></p><p>最后配置完wordpres的server模块☝️  部署任务基本完成 ，然后进入浏览器输入192.168.10.200/wordpress 测试：</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231213222833734.png" alt="image-20231213222833734"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231213223315866.png" alt="image-20231213223315866"></p><p>点击开始，依次填入账户数据信息，就可以见到我们wordpress博客的真正面目了，我们可以随时进行主题更换和内容编辑发布。</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231213225104254.png" alt="image-20231213225104254"></p><p>同样的产品有很多，比如知乎开源版代码wecenter，我们也可以尝试自己部署一下，效果如下：</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231213225627077.png" alt="image-20231213225627077"></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;LNMP架构部署动态产品&lt;/center&gt;&lt;/h1&gt;
&lt;h2 id=&quot;一、LNMP架构概述&quot;&gt;一、LNMP架构概述&lt;/h2&gt;
&lt;p&gt;LNMP是一套技术的组合，L = Linux、N = Nginx、M = MySQL、P = PHP，其工作原理如下：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231213204833175.png&quot; alt=&quot;image-20231213204833175&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1.用户通过http协议发起请求，请求会先抵达LNMP架构中的Nginx&lt;br&gt;
2.Nginx会根据用户的请求进行判断，这个判断是有Location进行完成&lt;br&gt;
3.判断用户请求的是静态页面，Nginx直接进行处理&lt;br&gt;
4.判断用户请求的是动态页面，Nginx会将该请求交给fastcgi协议下发&lt;br&gt;
5.fastgi会将请求交给php-fpm管理进程, php-fpm管理进程接收到后会调用工作进程warrap工作&lt;br&gt;
6.warrap进程会调用php程序进行解析,如果只是解析代码php直接返回&lt;br&gt;
7.如果有查询数据库操作，则由php连接数据库(用户 密码 IP)发起查询的操作&lt;br&gt;
8.最终数据由 mysql-&amp;gt;php-&amp;gt;php-fpm-&amp;gt;fastcgi-&amp;gt;nginx-&amp;gt;http-&amp;gt;user&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;二、Nginx-PHP演示&quot;&gt;二、Nginx+PHP演示&lt;/h2&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;服务准备&lt;/th&gt;
&lt;th&gt;IP地址&lt;/th&gt;
&lt;th&gt;主机名&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Nginx、PHP&lt;/td&gt;
&lt;td&gt;192.168.10.200&lt;/td&gt;
&lt;td&gt;web1&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;nginx前面我们已经讲述过了，三种方式均可，这里不再赘述，我们简要说一下PHP服务和数据库的安装。&lt;/p&gt;</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="服务架构" scheme="https://smallflames.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>Nginx模块简述</title>
    <link href="https://smallflames.github.io/2023/12/12/Nginx%E6%A8%A1%E5%9D%97%E7%AE%80%E8%BF%B0/"/>
    <id>https://smallflames.github.io/2023/12/12/Nginx%E6%A8%A1%E5%9D%97%E7%AE%80%E8%BF%B0/</id>
    <published>2023-12-12T12:16:58.000Z</published>
    <updated>2023-12-13T12:15:49.173Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>Nginx模块简述</center></h1><h2 id="一、Nginx配置文件介绍">一、Nginx配置文件介绍</h2><p>  Nginx服务的默认全局配置文件路径为：<code>/etc/nginx/nginx.conf</code>；路径因人而异，不同的人使用不同的安装方式（编译安装、epel仓库、官方仓库），那么nginx的模块位置信息也会不一样，我们也可以使用命令：<code>nginx -V</code>  查看nginx具体模块信息：</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231212203938019.png" alt="image-20231212203938019"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@nanxi ~]<span class="comment">#egrep -nv &#x27;^$|^#&#x27; /etc/nginx/nginx.conf</span></span><br><span class="line">2:user  www;         <span class="comment">### 用户</span></span><br><span class="line">3:worker_processes  auto;   <span class="comment">### 工作进程（建议与CPU数量一致或auto）</span></span><br><span class="line">5:error_log  /var/log/nginx/error.log notice;  <span class="comment">###错误日志路径</span></span><br><span class="line">6:pid        /var/run/nginx.pid;   <span class="comment">###  pid模块路径</span></span><br><span class="line">9:events &#123;                         <span class="comment">###  事件模块</span></span><br><span class="line">10:    worker_connections  1024;   <span class="comment">###  每个worker进程支持的最大连接数</span></span><br><span class="line">11:&#125;</span><br><span class="line">14:http &#123;                          <span class="comment">###  http网络模块</span></span><br><span class="line">15:    include       /etc/nginx/mime.types;       <span class="comment">###  包含资源类型文件</span></span><br><span class="line">16:    default_type  application/octet-stream;    <span class="comment">###  不在资源类型内的文件类型，会默认以下载方式传输给浏览器</span></span><br><span class="line">18:    log_format  main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot;&#x27;</span></span><br><span class="line">19:    <span class="comment">##日志格式##        &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">20:                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line">22:    access_log  /var/log/nginx/access.log  main;    <span class="comment">###  网络访问日志</span></span><br><span class="line">24:    sendfile        on;                  <span class="comment">###  高效文件传输</span></span><br><span class="line">27:    keepalive_timeout  65;               <span class="comment">###  长连接超时时间</span></span><br><span class="line">31:    include /etc/nginx/conf.d/*.conf;    <span class="comment">###  引入所有的配置文件</span></span><br><span class="line">32:&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用Server模块配置网站, 每个Server&#123;&#125;代表一个网站(简称虚拟主机)；</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;            <span class="comment">#监听端口, 默认80</span></span><br><span class="line">    server_name  nanxi.com;     <span class="comment">#提供的域名 _表示以IP地址方式进行访问</span></span><br><span class="line">    <span class="comment">### access_log  access.log;     #该网站的访问日志</span></span><br><span class="line">    <span class="comment">### 自定义将当前的server网站的访问日志记录至对应的目录，使用main格式</span></span><br><span class="line">    access_log /var/log/nginx/nanxi.com.log main;</span><br><span class="line">    <span class="comment">#location模块控制网站访问路径；</span></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /usr/share/nginx/html;   <span class="comment">#存放网站源代码的位置（nginx的默认欢迎页）</span></span><br><span class="line">        index  index.html index.htm;    <span class="comment">#默认返回网站的文件</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><span id="more"></span><blockquote><p><em>http{}层下允许有多个Server{}层，一个Server{}层下又允许有多个Location{}</em><br><em>http{} 标签主要用来解决用户的请求与响应。</em><br><em>server{} 标签主要用来响应具体的某一个网站。</em><br><em>location{}标签主要用于匹配网站具体URL路径。</em></p></blockquote><p>  使用 <code>rpm -ql nginx</code> 可查看nginx软件包的安装列表；<em>（ <code>rpm -qa nginx</code> 查看nginx软件是否存在）</em>，这里摘要几个最主要的文件必须了解：</p><table><thead><tr><th><strong>路径</strong></th><th><strong>类型</strong></th><th><strong>作用</strong></th></tr></thead><tbody><tr><td>/etc/nginx/nginx.conf</td><td>配置文件</td><td>nginx(全局)主配置文件</td></tr><tr><td>/etc/nginx/conf.d/default.conf</td><td>配置文件</td><td>默认网站配置文件</td></tr><tr><td>/etc/logrotate.d/nginx</td><td>配置文件</td><td>Nginx默认的日志切割</td></tr><tr><td>/var/log/nginx/access.log</td><td>日志文件</td><td>Nginx访问日志文件</td></tr><tr><td>/var/log/nginx/error.log</td><td>日志文件</td><td>Nginx错误日志文件</td></tr></tbody></table><div class='spoiler collapsed'>    <div class='spoiler-title'>        日志参数了解（内建变量）    </div>    <div class='spoiler-content'>        <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$remote_addr</span>             <span class="comment"># 记录客户端IP地址</span></span><br><span class="line"><span class="variable">$remote_user</span>             <span class="comment"># 记录客户端用户名</span></span><br><span class="line"><span class="variable">$time_local</span>              <span class="comment"># 记录通用的本地时间</span></span><br><span class="line"><span class="variable">$time_iso8601</span>            <span class="comment"># 记录ISO8601标准格式下的本地时间</span></span><br><span class="line"><span class="variable">$request</span>                 <span class="comment"># 记录请求的方法以及请求的http协议</span></span><br><span class="line"><span class="variable">$status</span>                  <span class="comment"># 记录请求状态码(用于定位错误信息)</span></span><br><span class="line"><span class="variable">$body_bytes_sent</span>         <span class="comment"># 发送给客户端的资源字节数，不包括响应头的大小</span></span><br><span class="line"><span class="variable">$bytes_sent</span>              <span class="comment"># 发送给客户端的总字节数</span></span><br><span class="line"><span class="variable">$msec</span>                    <span class="comment"># 日志写入时间。单位为秒，精度是毫秒。</span></span><br><span class="line"><span class="variable">$http_referer</span>            <span class="comment"># 记录从哪个页面链接访问过来的</span></span><br><span class="line"><span class="variable">$http_user_agent</span>         <span class="comment"># 记录客户端浏览器相关信息</span></span><br><span class="line"><span class="variable">$http_x_forwarded_for</span>    <span class="comment">#记录客户端IP地址</span></span><br><span class="line"><span class="variable">$request_length</span>          <span class="comment"># 请求的长度（包括请求行， 请求头和请求正文）。</span></span><br><span class="line"><span class="variable">$request_time</span>            <span class="comment"># 请求花费的时间，单位为秒，精度毫秒</span></span><br><span class="line"><span class="comment"># 注:如果Nginx位于负载均衡器，nginx反向代理之后，web服务器无法直接获取到客户端真实的IP地址。</span></span><br><span class="line"><span class="comment"># $remote_addr获取的是反向代理的IP地址。 反向代理服务器在转发请求的http头信息中。</span></span><br><span class="line"><span class="comment"># 增加X-Forwarded-For信息，用来记录客户端IP地址和客户端请求的服务器地址。</span></span><br></pre></td></tr></table></figure>    </div></div><p>  <mark>注意：配置文件配置完成后，如果是新增文件需要重启nginx服务，如果是修改配置文件那么只重载即可，记得检查配置文件配置是否有错误（可以使用 <code>nginx -t</code> 进行检查），如果有错重启时会报错，若配置错误后关闭nginx则无法再开启，直至配置文件修改正确为止。资源库的更改不需要重启服务。</mark></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@nanxi ~]<span class="comment">#nginx -t</span></span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</span><br></pre></td></tr></table></figure><h2 id="二、Nginx目录索引">二、Nginx目录索引</h2><p>  目录索引模块实现的效果类似资源站的下载页面，如以下阿里云的镜像站：</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231212221645012.png" alt="image-20231212221645012"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置方式：</span></span><br><span class="line">location /download &#123;</span><br><span class="line">    (root|<span class="built_in">alias</span>) /code;        <span class="comment">##  root展示的资源目录是/code/download/，alias展示的资源目录是/code/</span></span><br><span class="line">    autoindex on;              <span class="comment">##  开启目录索引，默认是关闭的</span></span><br><span class="line"><span class="comment">#   charset utf-8,gbk;         ##  指定字符编码格式，解决中文乱码问题</span></span><br><span class="line">    autoindex_exact_size off;  <span class="comment">##  以k、M、G的格式显示文件大小</span></span><br><span class="line">    autoindex_localtime on;    <span class="comment">##  显示的时间以系统创建时间为准</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  显示效果如下：（如显示乱码，则需要指定编码格式 <code>charset utf-8,gbk;</code>）</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231212224708812.png" alt="image-20231212224708812"></p><h2 id="三、Nginx状态监控">三、Nginx状态监控</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置方式：</span></span><br><span class="line">location /status &#123;</span><br><span class="line">    stub_status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  显示效果如下：</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231212230053944.png" alt="image-20231212230053944"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#参数详解：</span></span><br><span class="line">Active connections  <span class="comment"># 当前活动的连接数</span></span><br><span class="line">accepts             <span class="comment"># 已接收T的总TCP连接数量</span></span><br><span class="line">handled             <span class="comment"># 已处理的TCP连接数量</span></span><br><span class="line">requests            <span class="comment"># 当前http请求数</span></span><br><span class="line">Reading             <span class="comment"># 当前读取请求头数量</span></span><br><span class="line">Writing             <span class="comment"># 当前响应的请求头数量</span></span><br><span class="line">Waiting             <span class="comment"># 等待的请求数，开启了keepalive</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意, 一次TCP的连接，可以发起多次http的请求, 如下参数可配置进行验证</span></span><br><span class="line">keepalive_timeout  0;   <span class="comment"># 类似于关闭长连接</span></span><br><span class="line">keepalive_timeout  65;  <span class="comment"># 65s没有活动则断开连接</span></span><br></pre></td></tr></table></figure><h2 id="四、Nginx-访问限制">四、Nginx 访问限制</h2><h3 id="1、IP访问限制">1、IP访问限制</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置方式：</span></span><br><span class="line">location /status &#123;</span><br><span class="line">    stub_status;</span><br><span class="line">    (allow|deny)   192.168.10.1;      <span class="comment">#192.168.10.1为Windows本地虚拟网卡的地址，如果禁止我们就无法使用虚拟机通过本地浏览器访问了，当我们可以通过另一台虚拟机访问；活学活用可以看日志哈，当我们发现反常的IP访问数据，可以禁止这个IP的访问，注意不能一值禁止，因为我们不确定这个IP地址下是否存在正常用户！</span></span><br><span class="line">    (deny|allow)    all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231212231858117.png" alt="image-20231212231858117"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231212232052938.png" alt="image-20231212232052938"></p><h3 id="2、连接限制">2、连接限制</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置方式</span></span><br><span class="line">http&#123;   <span class="comment">#http层设置</span></span><br><span class="line">    limit_conn_zone <span class="variable">$remote_addr</span> zone=conn_zone:10m;</span><br><span class="line"></span><br><span class="line">server&#123; <span class="comment">#server层调用</span></span><br><span class="line">    ...</span><br><span class="line">    limit_conn conn_zone 1; <span class="comment">#连接限制，限制同时最高1个连接</span></span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3、请求限制">3、请求限制</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置方式</span></span><br><span class="line">http &#123;   <span class="comment">### http标签段定义请求限制, rate限制速率，限制一秒钟最多一个IP请求；</span></span><br><span class="line">    limit_req_zone <span class="variable">$binary_remote_addr</span> zone=req_zone:10m rate=1r/s;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name nanxi.com;</span><br><span class="line">    <span class="comment">#1r/s 只接收一个请求,其余请求拒绝处理并返回错误码给客户端；</span></span><br><span class="line">    <span class="comment">#limit_req zone=req_zone;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 请求超过1r/s,剩下的将被延迟处理,请求数超过burst定义的数量, 多余的请求默认返回503；</span></span><br><span class="line">    limit_req zone=req_zone burst=3 nodelay;</span><br><span class="line">    limit_req_status 478;   <span class="comment"># 自定义返回状态码 478；</span></span><br><span class="line">    error_page 478 /err.html;   <span class="comment"># 自定义返478错误页面；</span></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231212234736007.png" alt="image-20231212234736007"></p><p>  在nginx请求限制的过程中，我们可以自定义一个返回值，也就是错误页面的状态码。默认情况下是<code>503</code>（500以后的状态码多为数据库错误，为了方便区分，我们可以自定义一个状态码，如：478）;</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231212235604225.png" alt="image-20231212235604225"></p><h2 id="五、Nginx用户登陆认证">五、Nginx用户登陆认证</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要先安装httpd-tools，该包中携带了htpasswd命令，用来生成加密的密码</span></span><br><span class="line">[root@nanxi ~]<span class="comment">#yum install httpd-tools</span></span><br><span class="line"><span class="comment"># 创建新的密码文件, -c创建新文件 -b允许命令行输入密码</span></span><br><span class="line">[root@nanxi ~]<span class="comment">#htpasswd -b -c /etc/nginx/auth_conf nanxi nanxi</span></span><br><span class="line">Adding password <span class="keyword">for</span> user nanxi</span><br><span class="line"><span class="comment"># nginx配置调用</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">案例如下：</span><br><span class="line">location /download &#123;</span><br><span class="line">        root /code;</span><br><span class="line">        autoindex on;</span><br><span class="line">        autoindex_exact_size off;</span><br><span class="line">        autoindex_localtime on;</span><br><span class="line"></span><br><span class="line">        auth_basic <span class="string">&quot;Auth access Download  Input your Passwd!&quot;</span>;  <span class="comment">### 描述符提示</span></span><br><span class="line">        auth_basic_user_file auth_conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231212233614552.png" alt="image-20231212233614552"></p><h2 id="六、Location优先级">六、Location优先级</h2><table><thead><tr><th><strong>匹配符</strong></th><th><strong>匹配规则</strong></th><th><strong>优先级</strong></th></tr></thead><tbody><tr><td>=</td><td>精确匹配</td><td>1</td></tr><tr><td>^~</td><td>以某个字符串开头</td><td>2</td></tr><tr><td>~</td><td>区分大小写的正则匹配</td><td>3</td></tr><tr><td>~*</td><td>不区分大小写的正则匹配</td><td>4</td></tr><tr><td>/</td><td>通用匹配，任何请求都会匹配到</td><td>5</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 精准匹配，任何请求都会匹配到</span></span><br><span class="line">location = / &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不区分大小写匹配，只要用户访问.jpg,gif,png,js,css 都走这条location</span></span><br><span class="line">location ~* .*\.(jpg|gif|png|js|css)$ &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不区分大小写匹配</span></span><br><span class="line">location ~* <span class="string">&quot;\.(sql|bak|tgz|tar.gz|.git)$&quot;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通用匹配，任何请求都会匹配到</span></span><br><span class="line">location / &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>屠刀砍进中国人的心脏，震惊了中国魂，我们立志誓死捍卫祖国！铭记历史，祭奠民族伤痛~</p></blockquote><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231213093818586.png" alt="image-20231213093818586"></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;Nginx模块简述&lt;/center&gt;&lt;/h1&gt;
&lt;h2 id=&quot;一、Nginx配置文件介绍&quot;&gt;一、Nginx配置文件介绍&lt;/h2&gt;
&lt;p&gt;  Nginx服务的默认全局配置文件路径为：&lt;code&gt;/etc/nginx/nginx.conf&lt;/code&gt;；路径因人而异，不同的人使用不同的安装方式（编译安装、epel仓库、官方仓库），那么nginx的模块位置信息也会不一样，我们也可以使用命令：&lt;code&gt;nginx -V&lt;/code&gt;  查看nginx具体模块信息：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231212203938019.png&quot; alt=&quot;image-20231212203938019&quot;&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@nanxi ~]&lt;span class=&quot;comment&quot;&gt;#egrep -nv &amp;#x27;^$|^#&amp;#x27; /etc/nginx/nginx.conf&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2:user  www;         &lt;span class=&quot;comment&quot;&gt;### 用户&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3:worker_processes  auto;   &lt;span class=&quot;comment&quot;&gt;### 工作进程（建议与CPU数量一致或auto）&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5:error_log  /var/log/nginx/error.log notice;  &lt;span class=&quot;comment&quot;&gt;###错误日志路径&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6:pid        /var/run/nginx.pid;   &lt;span class=&quot;comment&quot;&gt;###  pid模块路径&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9:events &amp;#123;                         &lt;span class=&quot;comment&quot;&gt;###  事件模块&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10:    worker_connections  1024;   &lt;span class=&quot;comment&quot;&gt;###  每个worker进程支持的最大连接数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11:&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14:http &amp;#123;                          &lt;span class=&quot;comment&quot;&gt;###  http网络模块&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15:    include       /etc/nginx/mime.types;       &lt;span class=&quot;comment&quot;&gt;###  包含资源类型文件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16:    default_type  application/octet-stream;    &lt;span class=&quot;comment&quot;&gt;###  不在资源类型内的文件类型，会默认以下载方式传输给浏览器&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18:    log_format  main  &lt;span class=&quot;string&quot;&gt;&amp;#x27;$remote_addr - $remote_user [$time_local] &amp;quot;$request&amp;quot;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19:    &lt;span class=&quot;comment&quot;&gt;##日志格式##        &amp;#x27;$status $body_bytes_sent &amp;quot;$http_referer&amp;quot; &amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20:                      &lt;span class=&quot;string&quot;&gt;&amp;#x27;&amp;quot;$http_user_agent&amp;quot; &amp;quot;$http_x_forwarded_for&amp;quot;&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22:    access_log  /var/log/nginx/access.log  main;    &lt;span class=&quot;comment&quot;&gt;###  网络访问日志&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24:    sendfile        on;                  &lt;span class=&quot;comment&quot;&gt;###  高效文件传输&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27:    keepalive_timeout  65;               &lt;span class=&quot;comment&quot;&gt;###  长连接超时时间&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31:    include /etc/nginx/conf.d/*.conf;    &lt;span class=&quot;comment&quot;&gt;###  引入所有的配置文件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32:&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#使用Server模块配置网站, 每个Server&amp;#123;&amp;#125;代表一个网站(简称虚拟主机)；&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;server &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    listen       80;            &lt;span class=&quot;comment&quot;&gt;#监听端口, 默认80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server_name  nanxi.com;     &lt;span class=&quot;comment&quot;&gt;#提供的域名 _表示以IP地址方式进行访问&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;### access_log  access.log;     #该网站的访问日志&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;### 自定义将当前的server网站的访问日志记录至对应的目录，使用main格式&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    access_log /var/log/nginx/nanxi.com.log main;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;#location模块控制网站访问路径；&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    location / &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        root   /usr/share/nginx/html;   &lt;span class=&quot;comment&quot;&gt;#存放网站源代码的位置（nginx的默认欢迎页）&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        index  index.html index.htm;    &lt;span class=&quot;comment&quot;&gt;#默认返回网站的文件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="服务架构" scheme="https://smallflames.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>多服务脚本一键部署</title>
    <link href="https://smallflames.github.io/2023/12/09/%E5%A4%9A%E6%9C%8D%E5%8A%A1%E8%84%9A%E6%9C%AC%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2/"/>
    <id>https://smallflames.github.io/2023/12/09/%E5%A4%9A%E6%9C%8D%E5%8A%A1%E8%84%9A%E6%9C%AC%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2/</id>
    <published>2023-12-09T13:48:19.000Z</published>
    <updated>2024-01-21T09:21:56.211Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>多服务命令一键部署</center></h1><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/Snipaste_2023-12-08_21-04-18.png" alt="Snipaste_2023-12-08_21-04-18"></p><p>  突发奇想，用南汐前面讲过的知识写一个脚本吧，实现一键部署多服务。南汐设想的服务架构如上图☝️ ，简单介绍一下，这个架构由七台服务器实现，最前端的一台服务器专注我们的反向代理和负载均衡，我们暴露给客户的只能是一个域名，后面的三台web服务器为用户提供访问，后面有两台NFS服务器，来存储我们前端生成的静态文件，其中一台做备份使用，他们之间的数据要求实时同步，避免单点故障影响业务，最后面是我们的全局备份服务器，备份web端的重要配置文件和NFS服务器的重要数据文件。最后我们要实现用脚本一键部署这个架构的同时并实现定时任务备份。最终实现后的效果如下🔻 ：</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/nanxi_nginx.gif" alt="nanxi_nginx"></p><span id="more"></span><table><tr><td bgcolor=#000000><font color="white">环境准备</font></td></tr></table><table><thead><tr><th>角色</th><th>IP地址</th></tr></thead><tbody><tr><td>balance（负载均衡）</td><td>192.168.10.100</td></tr><tr><td>web01（web服务）</td><td>192.168.10.7</td></tr><tr><td>web02（web服务）</td><td>192.168.10.8</td></tr><tr><td>web03（web服务）</td><td>192.168.10.9</td></tr><tr><td>nfs（存储web文件）</td><td>192.168.10.31</td></tr><tr><td>nfs（实时备份nfs）</td><td>192.168.10.32</td></tr><tr><td>backup（全局备份）</td><td>192.168.10.41</td></tr></tbody></table><p>  注意，以上七台服务器必须提前在底层打通ssh免密登录，否则脚本无法运行！！！</p><table><tr><td bgcolor=#000000><font color="white">脚本展示</font></td></tr></table><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231209225426445.png" alt="image-20231209225426445"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231209225933776.png" alt="image-20231209225933776"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231209224546979.png" alt="image-20231209224546979"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231209224651697.png" alt="image-20231209224651697"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231209224924114.png" alt="image-20231209224924114"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231209225020693.png" alt="image-20231209225020693"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231209225223925.png" alt="image-20231209225223925"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231209225317592.png" alt="image-20231209225317592"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231209225547245.png" alt="image-20231209225547245"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231209225631187.png" alt="image-20231209225631187"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231209230226047.png" alt="image-20231209230226047"></p><p>  <mark>最后测试时别忘了修改本地的hosts文件，因为我们的业务对外唯一且仅能暴露的入口就是我们的域名！</mark><strong>南汐把脚本简本整理了一下放在了网上，下载地址：<a href="http://cdn.zzxe.eu.org/file/deplay.tar.gz%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%AF%B9%E6%82%A8%E6%9C%89%E5%B8%AE%E5%8A%A9%EF%BC%8C%E8%AE%B0%E5%BE%97%E6%94%B6%E8%97%8F%E4%B8%80%E4%B8%8B%E5%8D%97%E6%B1%90%E7%9A%84%E5%8D%9A%E5%AE%A2%EF%BC%8C%E5%88%AB%E8%B5%B0%E4%B8%A2%E4%BA%86%E5%93%A6~">http://cdn.zzxe.eu.org/file/deplay.tar.gz，如果对您有帮助，记得收藏一下南汐的博客，别走丢了哦~</a></strong></p><blockquote><p><em>我这个人走得很慢，但是我从不后退。</em></p><p align="right">——亚伯拉罕·林肯</p></blockquote><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;多服务命令一键部署&lt;/center&gt;&lt;/h1&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/XZ6606/image-bed/raw/master/img/Snipaste_2023-12-08_21-04-18.png&quot; alt=&quot;Snipaste_2023-12-08_21-04-18&quot;&gt;&lt;/p&gt;
&lt;p&gt;  突发奇想，用南汐前面讲过的知识写一个脚本吧，实现一键部署多服务。南汐设想的服务架构如上图☝️ ，简单介绍一下，这个架构由七台服务器实现，最前端的一台服务器专注我们的反向代理和负载均衡，我们暴露给客户的只能是一个域名，后面的三台web服务器为用户提供访问，后面有两台NFS服务器，来存储我们前端生成的静态文件，其中一台做备份使用，他们之间的数据要求实时同步，避免单点故障影响业务，最后面是我们的全局备份服务器，备份web端的重要配置文件和NFS服务器的重要数据文件。最后我们要实现用脚本一键部署这个架构的同时并实现定时任务备份。最终实现后的效果如下🔻 ：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/XZ6606/image-bed/raw/master/img/nanxi_nginx.gif&quot; alt=&quot;nanxi_nginx&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="服务架构" scheme="https://smallflames.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>Nginx服务简述</title>
    <link href="https://smallflames.github.io/2023/12/07/Nginx%E6%9C%8D%E5%8A%A1%E7%AE%80%E8%BF%B0/"/>
    <id>https://smallflames.github.io/2023/12/07/Nginx%E6%9C%8D%E5%8A%A1%E7%AE%80%E8%BF%B0/</id>
    <published>2023-12-07T12:05:15.000Z</published>
    <updated>2023-12-08T13:56:14.098Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>Nginx服务简述</center></h1><h2 id="一、了解Nginx">一、了解Nginx</h2><p>  Nginx (engine x) 是一个高性能的HTTP和反向代理web服务器，同时也提供了IMAP/POP3/SMTP服务。Nginx支持热部署，启动简单，可以做到7×24小时不间断运行，其特点是占有内存少，并发能力强，能经受高负载的考验，有报告表明能支持高达 50,000 个并发连接数。中国大陆使用nginx网站用户有：百度、京东、新浪、网易、腾讯、淘宝等。</p><p>  我们为什么选择Nginx服务?<br>  ①  开源：直接获取源代码；②  高性能: 支持海量并发；③  可靠: 服务稳定；④  Nginx非常轻量，功能模块少(源代码仅保留http与核心模块代码,其余不够核心代码会作为插件来安装)；⑤  代码模块化 (易读，便于二次开发，对于开发人员非常友好)；⑥  Nginx适合当前主流架构趋势，微服务、云架构、中间层等，且技术成熟；⑦  统一技术栈，降低维护成本，降低技术更新成本；</p><blockquote><p>Nginx采用Epool网络模型，Apache采用Select模型</p><p>  Select: 当用户发起一次请求，select模型就会进行一次遍历扫描，从而导致性能低下。Epool: 当用户发起请求，epool模型会直接进行处理，效率高效，并无连接限制。处理大量的连接的读写，Apache所采用的select网络I/O模型非常低效。</p><p>  用一个比喻来解释Apache采用的select模型和Nginx采用的epoll模型进行之间的区别：假设你在大学读书，住的宿舍楼有很多间房间，你的朋友要来找你。select版宿管大妈就会带着你的朋友挨个房间去找，直到找到你为止。而epoll版宿管大妈会先记下每位同学的房间号，你的朋友来时，只需告诉你的朋友你住在哪个房间即可，不用亲自带着你的朋友满大楼找人。如果来了10000个人，都要找自己住这栋楼的同学时，select版和epoll版宿管大妈，谁的效率更高，不言自明。同理，在高并发服务器中，轮询I/O是最耗时间的操作之 一，select和epoll的性能谁的性能更高，同样十分明了。</p></blockquote><h2 id="二、Nginx应用场景">二、Nginx应用场景</h2><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/5e3ba1cc0392485e0c000002.png" alt="5e3ba1cc0392485e0c000002"></p><span id="more"></span><h2 id="三、Nginx服务配置">三、Nginx服务配置</h2><p>  1️⃣   配置官网仓库，使用官网仓库下载；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@nanxi ~]<span class="comment">#vim /etc/yum.repos.d/nginx.repo</span></span><br><span class="line">需要配置官网的仓库，官方配置文档：http://nginx.org/en/linux_packages.html<span class="comment">#RHEL</span></span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231207202813450.png" alt="image-20231207202813450"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231207203732955.png" alt="image-20231207203732955"></p><p>  <mark>注意检查我们下载nginx时（<code>yum -y install nginx</code>）的下载源是否为我们设置的官方下载源；</mark></p><p>  2️⃣   配置并检查Nginx服务状态；</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231207204214920.png" alt="image-20231207204214920"></p><p>  3️⃣   浏览器测试Nginx网页；</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231207204514762.png" alt="image-20231207204514762"></p><p>  4️⃣   自定义Nginx网站配置；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]<span class="comment">#cd /etc/nginx/conf.d/</span></span><br><span class="line">[root@web01 /etc/nginx/conf.d]<span class="comment">#ll</span></span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 1072 Apr 12  2023 default.conf</span><br><span class="line">[root@web01 /etc/nginx/conf.d]<span class="comment">#rm -rf *</span></span><br><span class="line">[root@web01 /etc/nginx/conf.d]<span class="comment">#vim nanxi_game.conf</span></span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231207205016882.png" alt="image-20231207205016882"></p><p>  5️⃣   根据我们的配置创建文件，完善Nginx网站；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]<span class="comment">#mkdir /code</span></span><br><span class="line">[root@web01 ~]<span class="comment">#cd /code</span></span><br><span class="line">[root@web01 /code]<span class="comment">#ll</span></span><br><span class="line">total 0</span><br><span class="line">[root@web01 /code]<span class="comment">#rz -E       ###上传了一个小游戏</span></span><br><span class="line">rz waiting to receive.</span><br><span class="line">[root@web01 /code]<span class="comment">#ll</span></span><br><span class="line">total 7720</span><br><span class="line">-rw-r--r-- 1 root root 7902976 Dec  7 19:26 小霸王游戏机.zip</span><br><span class="line">[root@web01 /code]<span class="comment">#unzip 小霸王游戏机.zip</span></span><br><span class="line">......</span><br><span class="line">[root@web01 /code]<span class="comment">#ll</span></span><br><span class="line">total 7768</span><br><span class="line">-rw-r--r-- 1 root root   28032 May 24  2021 bgm.mp3</span><br><span class="line">drwxr-xr-x 2 root root      23 May 24  2021 css</span><br><span class="line">drwxr-xr-x 2 root root      23 May 24  2021 images</span><br><span class="line">-rw-r--r-- 1 root root    8956 May 24  2021 index.html</span><br><span class="line">drwxr-xr-x 2 root root     213 May 24  2021 js</span><br><span class="line">drwxr-xr-x 2 root root    4096 May 24  2021 roms</span><br><span class="line">-rw-r--r-- 1 root root     811 May 24  2021 shuoming.html</span><br><span class="line">-rw-r--r-- 1 root root 7902976 Dec  7 19:26 小霸王游戏机.zip</span><br></pre></td></tr></table></figure><p>  6️⃣   重启Nginx服务，再次打开浏览器；</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231207210520721.png" alt="image-20231207210520721"></p><hr><p>🔎    学而不思则罔，留下一个小问题？记得先思考再查看解决方案哦~</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231207213401273.png" alt="image-20231207213401273"></p><div class='spoiler collapsed'>    <div class='spoiler-title'>        一个Nginx服务部署多业务站点解决方案    </div>    <div class='spoiler-content'>        <table><tr><td bgcolor=#000000><font color="white">方案一：使用多IP部署</font></td></tr></table><p>  ①  增加多个虚拟IP地址；命令如：<code>ip addr add 192.168.10.66/24 dev eth0</code>  ②  把我们配置过的文件，复制两份分别重新命名，修改他们为监听不同的IP地址，然后完善相应配置即可；③  重启Nginx，测试访问；<em>（这种方式已不再使用，仅供了解，访问效果与下面一致，不再展示）</em></p><table><tr><td bgcolor=#000000><font color="white">方案二：使用多端口部署</font></td></tr></table><p>  把我们配置过的文件，复制两份分别重新命名，修改他们为不同的端口，然后完善相应配置即可；</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231208152603332.png" alt="image-20231208152603332"></p><p>  使用命令查看配置是否有错，没有则重启Nginx服务即可，测试访问如下；</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231208153828448.png" alt="image-20231208153828448"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231208153906179.png" alt="image-20231208153906179"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231208153922229.png" alt="image-20231208153919892"></p><table><tr><td bgcolor=#000000><font color="white">方案三：使用多域名部署★★★★★</font></td></tr></table><p>  把我们配置过的文件，复制两份分别重新命名，分别设为不同的域名，然后完善相应配置即可；记得重载服务配置文件和修改Windows本地Hosts文件！</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231208154955412.png" alt="image-20231208154955412"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231208160007013.png" alt="image-20231208160007013"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231208155824638.png" alt="image-20231208155824638"></p>    </div></div><p> </p><blockquote><p><em>不要努力成为一个成功者，要努力成为一个有价值的人。</em></p><p align="right">——爱因斯坦</p></blockquote><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;Nginx服务简述&lt;/center&gt;&lt;/h1&gt;
&lt;h2 id=&quot;一、了解Nginx&quot;&gt;一、了解Nginx&lt;/h2&gt;
&lt;p&gt;  Nginx (engine x) 是一个高性能的HTTP和反向代理web服务器，同时也提供了IMAP/POP3/SMTP服务。Nginx支持热部署，启动简单，可以做到7×24小时不间断运行，其特点是占有内存少，并发能力强，能经受高负载的考验，有报告表明能支持高达 50,000 个并发连接数。中国大陆使用nginx网站用户有：百度、京东、新浪、网易、腾讯、淘宝等。&lt;/p&gt;
&lt;p&gt;  我们为什么选择Nginx服务?&lt;br&gt;
  ①  开源：直接获取源代码；②  高性能: 支持海量并发；③  可靠: 服务稳定；④  Nginx非常轻量，功能模块少(源代码仅保留http与核心模块代码,其余不够核心代码会作为插件来安装)；⑤  代码模块化 (易读，便于二次开发，对于开发人员非常友好)；⑥  Nginx适合当前主流架构趋势，微服务、云架构、中间层等，且技术成熟；⑦  统一技术栈，降低维护成本，降低技术更新成本；&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Nginx采用Epool网络模型，Apache采用Select模型&lt;/p&gt;
&lt;p&gt;  Select: 当用户发起一次请求，select模型就会进行一次遍历扫描，从而导致性能低下。Epool: 当用户发起请求，epool模型会直接进行处理，效率高效，并无连接限制。处理大量的连接的读写，Apache所采用的select网络I/O模型非常低效。&lt;/p&gt;
&lt;p&gt;  用一个比喻来解释Apache采用的select模型和Nginx采用的epoll模型进行之间的区别：假设你在大学读书，住的宿舍楼有很多间房间，你的朋友要来找你。select版宿管大妈就会带着你的朋友挨个房间去找，直到找到你为止。而epoll版宿管大妈会先记下每位同学的房间号，你的朋友来时，只需告诉你的朋友你住在哪个房间即可，不用亲自带着你的朋友满大楼找人。如果来了10000个人，都要找自己住这栋楼的同学时，select版和epoll版宿管大妈，谁的效率更高，不言自明。同理，在高并发服务器中，轮询I/O是最耗时间的操作之 一，select和epoll的性能谁的性能更高，同样十分明了。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;二、Nginx应用场景&quot;&gt;二、Nginx应用场景&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/XZ6606/image-bed/raw/master/img/5e3ba1cc0392485e0c000002.png&quot; alt=&quot;5e3ba1cc0392485e0c000002&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="服务架构" scheme="https://smallflames.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>sersync文件实时同步</title>
    <link href="https://smallflames.github.io/2023/12/06/sersync%E6%96%87%E4%BB%B6%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5/"/>
    <id>https://smallflames.github.io/2023/12/06/sersync%E6%96%87%E4%BB%B6%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5/</id>
    <published>2023-12-06T12:19:36.000Z</published>
    <updated>2024-01-21T09:21:29.577Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>sersync文件实时同步</center></h1><h2 id="一、sersync应用场景">一、sersync应用场景</h2><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231206214137354.png" alt="image-20231206214137354"></p><p>  如上图所示，如果我们只有一台NFS服务器，当它发生故障时，对我们的web服务端会产生非常大的业务影响，这就时单台设备的瓶颈，我们称这一现象为单点故障，试想如果我们此时还有一台服务器专门为NFS服务器做数据备份，当我们的NFS服务器出现故障，我们可以及时的把NFS服务器的备份服务器迅速挂载至web端，快速恢复业务。但这有一个非常重要的要求，我们的备份服务器和备份源数据必须实时同步（实时同步是一种只要当前目录发生变化则会触发一个事件，事件触发后会将变化的目录同步至远程服务器。），否则就会造成用户访问的数据不连续，影响业务正常运行。此时我们就可以用到sersync的功能了。</p><p>  sersync是国人基于<code>rsync+inotify-tools</code>开发的工具，不仅保留了优点同时还强化了实时监控，文件过滤，简化配置等功能，帮助用户提高运行效率，节省时间和网络资源。👉<a href="https://github.com/wsgzao/sersync">sersync项目地址</a></p><span id="more"></span><h2 id="二、环境准备">二、环境准备</h2><table><thead><tr><th>角色</th><th>IP地址（LAN）</th><th>主机名</th></tr></thead><tbody><tr><td>nfs服务器（客户端）</td><td>eth1：172.16.1.31</td><td>nfs1</td></tr><tr><td>nfs服务器（服务端）</td><td>eth1：172.16.1.32</td><td>nfs2</td></tr></tbody></table><h2 id="三、服务配置">三、服务配置</h2><p>  1️⃣   安装inotify-tools，下载sersync；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs ~]<span class="comment"># mkdir -p /server/tools </span></span><br><span class="line">[root@nfs /server/tools]<span class="comment"># wget https://raw.githubusercontent.com/wsgzao/sersync/master/sersync2.5.4_64bit_binary_stable_final.tar.gz</span></span><br><span class="line">[root@nfs /server/tools]<span class="comment"># tar xf sersync.tar.gz</span></span><br><span class="line">[root@nfs tools]<span class="comment"># mv GNU-Linux-x86 sersync</span></span><br><span class="line"><span class="comment">###  GNU-Linux-x86就是我们说的sersync</span></span><br><span class="line">[root@nfs1 /server/tools/sersync]<span class="comment">#ll</span></span><br><span class="line">total 1772</span><br><span class="line">-rwxr-xr-x 1 root root    2213 Dec 6 16:32 confxml.xml</span><br><span class="line">-rwxr-xr-x 1 root root 1810128 Oct 26 2011 sersync2</span><br></pre></td></tr></table></figure><p>  2️⃣   设置配置文件信息；（confxml.xml）</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231206211100056.png" alt="image-20231206211100056"></p><p>  3️⃣     开启监控；（命令：<code>/server/tools/sersync/sersync2 -dro /server/tools/sersync/confxml.xml</code>）</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231206211735253.png" alt="image-20231206211735253"></p><p>  4️⃣   测试验证；</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231206211921159.png" alt="image-20231206211921159"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231206212033812.png" alt="image-20231206212033812"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231206212127238.png" alt="image-20231206212127238"></p><p>  5️⃣   注意事项：<mark>配置完成后，监控目录发生文件变化，但服务端未实时同步，此时我们首先搜索该推送进程，结束该进程后再次尝试运行，避免后台大量进程堆积。</mark></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;sersync文件实时同步&lt;/center&gt;&lt;/h1&gt;
&lt;h2 id=&quot;一、sersync应用场景&quot;&gt;一、sersync应用场景&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231206214137354.png&quot; alt=&quot;image-20231206214137354&quot;&gt;&lt;/p&gt;
&lt;p&gt;  如上图所示，如果我们只有一台NFS服务器，当它发生故障时，对我们的web服务端会产生非常大的业务影响，这就时单台设备的瓶颈，我们称这一现象为单点故障，试想如果我们此时还有一台服务器专门为NFS服务器做数据备份，当我们的NFS服务器出现故障，我们可以及时的把NFS服务器的备份服务器迅速挂载至web端，快速恢复业务。但这有一个非常重要的要求，我们的备份服务器和备份源数据必须实时同步（实时同步是一种只要当前目录发生变化则会触发一个事件，事件触发后会将变化的目录同步至远程服务器。），否则就会造成用户访问的数据不连续，影响业务正常运行。此时我们就可以用到sersync的功能了。&lt;/p&gt;
&lt;p&gt;  sersync是国人基于&lt;code&gt;rsync+inotify-tools&lt;/code&gt;开发的工具，不仅保留了优点同时还强化了实时监控，文件过滤，简化配置等功能，帮助用户提高运行效率，节省时间和网络资源。👉&lt;a href=&quot;https://github.com/wsgzao/sersync&quot;&gt;sersync项目地址&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="服务架构" scheme="https://smallflames.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>NFS共享存储</title>
    <link href="https://smallflames.github.io/2023/12/05/NFS%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8/"/>
    <id>https://smallflames.github.io/2023/12/05/NFS%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8/</id>
    <published>2023-12-05T10:40:01.000Z</published>
    <updated>2023-12-05T13:26:18.001Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1><center>NFS共享存储</center></h1><h2 id="一、NFS基本概述">一、NFS基本概述</h2><p>  NFS是Network File System的缩写及网络文件系统。<mark>NFS主要功能是通过局域网络让不同的主机系统之间可以共享文件或目录</mark>。NFS系统和Windows网络共享、网络驱动器类似，只不过windows用于局域网，NFS用于企业集群架构中，如果是大型网站会用到更复杂的分布式文件系统FastDFS、glusterfs、HDFS……</p><p>  🔎    为什么要用共享存储呢？</p><p>  ① 为了实现多台服务器之间数据共享；② 实现多台服务器之间数据一致</p><p>  <strong>实例解释</strong>：A用户上传图片经过负载均衡，负载均衡将上传请求调度至Web1服务器上。B用户访问A用户上传的图片，此时B用户被负载均衡调度至Web2上，因为Web2上没有这张图片，所以B用户无法看到A用户传的图片，试想一下，如果微信的架构是这样的，那我们还会有朋友圈📸这个这样的功能吗？</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/5e339ca91352cb3909000000.png" alt="5e339ca91352cb3909000000"></p><p>  <strong>实例解释</strong>：如果使用NFS服务，此时A用户上传图片无论被负载均衡调度至Web1还是Web2, 最终数据都被写入至共享存储，当B用户访问A用户上传图片时，无论负载均衡将其调度至Web1还是Web2，最终都会通过NFS共享存储访问到对应的文件。</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/5e339cc11352cb3909000001.png" alt="5e339cc11352cb3909000001"></p><span id="more"></span><h2 id="二、NFS服务原理">二、NFS服务原理</h2><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/5e339cf31352cb3909000002.png" alt="5e339cf31352cb3909000002"></p><p>  本地过程调用：当用户本地执行某个命令时，该命令会调用<code>shell</code>解释器翻译给内核，内核解析完成后会驱动对应的硬件设备，完成相应的操作。</p><p>  远程过程调用：当用户本地执行某个命令时，命令实际写入的地址示远程服务器，则该命令会通过通过网络协议传递给我们实际写入地址的远程服务器，服务器再进行本地过程调用。</p><p>  NFS服务的实现就是一个远程过程调用：</p><blockquote><p>1.用户进程访问NFS客户端，使用不同的函数对数据进行处理；<br>2.NFS客户端通过TCP/IP的方式传递给NFS服务端；<br>3.NFS服务端接收到请求后，会先调用portmap进程进行端口映射；<br>4.nfsd进程用于判断NFS客户端是否拥有权限连接NFS服务端；<br>5.Rpc.mount进程判断客户端是否有对应的权限进行验证；<br>6.idmap进程实现用户映射和压缩；<br>7.最后NFS服务端会将对应请求进行本地过程调用，以完成客户端相应的操作；</p></blockquote><h2 id="三、NFS服务配置">三、NFS服务配置</h2><h3 id="1、服务端配置">1、服务端配置</h3><p>  1️⃣   关闭防火墙；（以免默认的防火墙策略禁止正常的NFS共享服务）</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231205190914379.png" alt="image-20231205190914379"></p><p>  2️⃣   安装NFS服务端；<code>yum -y install nfs-utils</code>；</p><p>  3️⃣   对NFS服务的配置文件<code>/etc/exports</code>进行配置；</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231205191827982.png" alt="image-20231205191827982"></p><p>  <mark>需要严格按照共享目录的路径、允许访问的NFS客户端(共享权限参数)的格式书写！定义要共享的目录与之相应的权限，具体书写方式如下图所示；</mark></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/5e339d441352cb3909000003.png" alt="5e339d441352cb3909000003"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231205193753621.png" alt="20231205193753621"></p><p>  <font color="red">NFS共享目录及配置会记录至<code>/var/lib/nfs/etab</code>，<strong>配置完成需要重启NFS服务</strong>，然后再查看<code>/var/lib/nfs/etab</code>，如果该目录不存在共享信息，则表示配置错误，请重新检查配置信息！</font></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231205194753355.png" alt="image-20231205194753355"></p><p>  4️⃣      设置开机自启动服务；（在使用NFS服务进行文件共享之前，需要使用RPC–Remote Procedure Call远程过程调用服务将NFS服务器的IP地址和端口号信息发送给客户端。因此，在启动NFS服务之前，需要先重启并启用rpcbind服务程序,同时都加入开机自启动）</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231205195450456.png" alt="image-20231205195450456"></p><p>  再次检测端口和文件，确保配置正确且服务正常运行。</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231205195525310.png" alt="image-20231205195525310"></p><h3 id="2、客户端配置">2、客户端配置</h3><p>  1️⃣   客户端挂载；（在NFS客户端创建一个挂载目录, 使用mount命令挂载）</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231205202533661.png" alt="image-20231205202533661"></p><h3 id="3、使用测试">3、使用测试</h3><p>  ①  客户端创建文件，相当于直接在NFS服务端直接写入；</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231205202830406.png" alt="image-20231205202830406"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231205202907165.png" alt="image-20231205202907165"></p><p>  ②  多台客户端挂载NFS服务端，进行访问，内容一致；</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231205203618304.png" alt="image-20231205203618304"></p><p>  ③  文件在NFS服务端删除后，所有客户端均无法访问；</p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231205203846170.png" alt="image-20231205203846170"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231205203909936.png" alt="image-20231205203909936"></p><p><img src="https://gitee.com/XZ6606/image-bed/raw/master/img/image-20231205203959785.png" alt="image-20231205203959785"></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h1&gt;&lt;center&gt;NFS共享存储&lt;/center&gt;&lt;/h1&gt;
&lt;h2 id=&quot;一、NFS基本概述&quot;&gt;一、NFS基本概述&lt;/h2&gt;
&lt;p&gt;  NFS是Network File System的缩写及网络文件系统。&lt;mark&gt;NFS主要功能是通过局域网络让不同的主机系统之间可以共享文件或目录&lt;/mark&gt;。NFS系统和Windows网络共享、网络驱动器类似，只不过windows用于局域网，NFS用于企业集群架构中，如果是大型网站会用到更复杂的分布式文件系统FastDFS、glusterfs、HDFS……&lt;/p&gt;
&lt;p&gt;  🔎    为什么要用共享存储呢？&lt;/p&gt;
&lt;p&gt;  ① 为了实现多台服务器之间数据共享；② 实现多台服务器之间数据一致&lt;/p&gt;
&lt;p&gt;  &lt;strong&gt;实例解释&lt;/strong&gt;：A用户上传图片经过负载均衡，负载均衡将上传请求调度至Web1服务器上。B用户访问A用户上传的图片，此时B用户被负载均衡调度至Web2上，因为Web2上没有这张图片，所以B用户无法看到A用户传的图片，试想一下，如果微信的架构是这样的，那我们还会有朋友圈📸这个这样的功能吗？&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/XZ6606/image-bed/raw/master/img/5e339ca91352cb3909000000.png&quot; alt=&quot;5e339ca91352cb3909000000&quot;&gt;&lt;/p&gt;
&lt;p&gt;  &lt;strong&gt;实例解释&lt;/strong&gt;：如果使用NFS服务，此时A用户上传图片无论被负载均衡调度至Web1还是Web2, 最终数据都被写入至共享存储，当B用户访问A用户上传图片时，无论负载均衡将其调度至Web1还是Web2，最终都会通过NFS共享存储访问到对应的文件。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/XZ6606/image-bed/raw/master/img/5e339cc11352cb3909000001.png&quot; alt=&quot;5e339cc11352cb3909000001&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="运维之路" scheme="https://smallflames.github.io/tags/%E8%BF%90%E7%BB%B4%E4%B9%8B%E8%B7%AF/"/>
    
    <category term="服务架构" scheme="https://smallflames.github.io/tags/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
</feed>
